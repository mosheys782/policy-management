<!DOCTYPE html>
<!-- Version 16 - Sticky Header + Filter Fix -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policy Management</title>
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f0f2f5;font-size:15px}
        .login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
        .login-card{background:#fff;padding:60px;border-radius:20px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
        .login-card h1{font-size:28px;margin-bottom:12px;color:#333}
        .login-card p{color:#666;margin-bottom:40px;font-size:16px}
        .login-btn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:16px 40px;border-radius:10px;font-size:16px;cursor:pointer;font-weight:600}
        .app{display:none}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:16px 32px;display:flex;justify-content:space-between;align-items:center}
        .header h1{font-size:22px;font-weight:600}
        .header-right{display:flex;gap:16px;align-items:center}
        .search-box{position:relative}
        .search-box input{padding:10px 16px 10px 40px;border-radius:10px;border:none;width:250px;font-size:14px;background:rgba(255,255,255,0.2);color:#fff}
        .search-box input::placeholder{color:rgba(255,255,255,0.7)}
        .search-box:before{content:'üîç';position:absolute;left:12px;top:50%;transform:translateY(-50%)}
        .new-btn{background:#fff;color:#764ba2;border:none;padding:10px 20px;border-radius:10px;font-weight:600;cursor:pointer}
        .user-badge{display:flex;align-items:center;gap:10px;cursor:pointer;padding:6px 12px;border-radius:10px;background:rgba(255,255,255,0.15)}
        .user-badge .avatar{width:36px;height:36px;border-radius:50%;background:#fff;color:#764ba2;display:flex;align-items:center;justify-content:center;font-weight:700}
        .main{padding:24px 32px;max-width:1900px;margin:0 auto}
        .stats{display:grid;grid-template-columns:repeat(6,1fr);gap:20px;margin-bottom:28px}
        .stat{padding:24px;border-radius:16px;cursor:pointer;transition:all 0.2s;border:1px solid transparent}
        .stat:hover{transform:translateY(-3px);box-shadow:0 12px 30px rgba(0,0,0,0.15)}
        .stat .num{font-size:42px;font-weight:800;margin-bottom:4px}
        .stat .label{font-size:14px;font-weight:600;opacity:0.9}
        .stat.red{background:linear-gradient(135deg,#fecaca,#fca5a5);color:#991b1b;border-color:#f87171}
        .stat.orange{background:linear-gradient(135deg,#fed7aa,#fdba74);color:#c2410c;border-color:#fb923c}
        .stat.gray{background:linear-gradient(135deg,#e2e8f0,#cbd5e1);color:#334155;border-color:#94a3b8}
        .stat.teal{background:linear-gradient(135deg,#99f6e4,#5eead4);color:#0f766e;border-color:#2dd4bf}
        .stat.rose{background:linear-gradient(135deg,#fecdd3,#fda4af);color:#be123c;border-color:#fb7185}
        .stat.green{background:linear-gradient(135deg,#a7f3d0,#6ee7b7);color:#065f46;border-color:#34d399}
        .tabs{background:#fff;border-radius:16px;margin-bottom:24px;box-shadow:0 4px 12px rgba(0,0,0,0.08);border:1px solid #e2e8f0}
        .tab-row{display:flex;border-bottom:1px solid #e5e7eb;padding:0 8px}
        .tab{padding:16px 24px;cursor:pointer;border-bottom:3px solid transparent;font-weight:500;font-size:15px;color:#64748b;display:flex;align-items:center;gap:8px;transition:all 0.15s}
        .tab:hover{color:#7c3aed;background:#faf5ff}
        .tab.active{color:#7c3aed;border-bottom-color:#7c3aed;background:#faf5ff}
        .tab .count{background:#e2e8f0;padding:3px 11px;border-radius:12px;font-size:13px;font-weight:600}
        .tab.active .count{background:#7c3aed;color:#fff}
        .tab-divider{width:1px;background:#e5e7eb;margin:12px 8px}
        .filters{padding:16px 24px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;background:#f8fafc;border-top:1px solid #e2e8f0}
        .filters select{padding:10px 14px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;min-width:140px;cursor:pointer;background:#fff;color:#334155;font-weight:500}
        .filters select:hover{border-color:#7c3aed}
        .filters select:focus{outline:none;border-color:#7c3aed;box-shadow:0 0 0 3px rgba(124,58,237,0.1)}
        .filters label{display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer;color:#475569;font-weight:500}
        .filters label input{width:18px;height:18px;accent-color:#7c3aed}
        .grid{background:#fff;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,0.08);border:1px solid #e2e8f0;overflow:visible}
        .grid-header{display:grid;grid-template-columns:minmax(200px,1.5fr) 75px 90px 90px 130px 150px 110px 40px;padding:16px 20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);font-size:12px;font-weight:700;color:#fff;text-transform:uppercase;letter-spacing:0.8px;gap:8px;position:sticky;top:0;z-index:10;border-radius:16px 16px 0 0}
        .grid-header.billing{grid-template-columns:minmax(180px,1.5fr) 75px 85px 85px 105px 105px 140px 105px 40px}
        #gridBody{display:block;width:100%}
        .grid-row{display:grid;grid-template-columns:minmax(200px,1.5fr) 75px 90px 90px 130px 150px 110px 40px;padding:16px 20px;border-bottom:1px solid #e2e8f0;align-items:center;cursor:pointer;gap:8px;width:100%}
        .grid-row.billing{grid-template-columns:minmax(180px,1.5fr) 75px 85px 85px 105px 105px 140px 105px 40px}
        .grid-row:nth-child(even){background:#f8fafc}
        .grid-row:hover{background:#ede9fe;box-shadow:inset 3px 0 0 #7c3aed}
        .policy-cell{display:flex;gap:12px;align-items:flex-start;min-width:0}
        .policy-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;box-shadow:0 3px 8px rgba(0,0,0,0.1)}
        .policy-info{min-width:0;flex:1}
        .policy-info h3{font-size:13px;font-weight:700;margin-bottom:4px;line-height:1.35;color:#1e293b}
        .policy-info .meta{font-size:12px;color:#64748b;margin-bottom:3px}
        .policy-info .carrier{font-size:12px;color:#0369a1;font-weight:600;margin-bottom:4px}
        .policy-info .notes{font-size:12px;color:#047857;background:#d1fae5;padding:5px 12px;border-radius:8px;display:inline-block;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:600;border:1px solid #6ee7b7;box-shadow:0 2px 4px rgba(16,185,129,0.15)}
        .due-cell{text-align:center}
        .trans-cell{text-align:center}
        .trans-badge{display:inline-block;padding:5px 10px;border-radius:8px;font-size:11px;font-weight:700;white-space:nowrap;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
        .date-cell{font-size:12px;color:#334155;text-align:center;white-space:nowrap;font-weight:500}
        .due-badge{display:inline-block;padding:6px 10px;border-radius:8px;font-size:11px;font-weight:700;white-space:nowrap;letter-spacing:0.3px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border:none}
        .due-badge.past{background:#fee2e2;color:#b91c1c;box-shadow:0 2px 6px rgba(248,113,113,0.3);border:none}
        .due-badge.today{background:#fef3c7;color:#92400e;box-shadow:0 2px 6px rgba(251,191,36,0.3);border:none}
        .due-badge.soon{background:#dbeafe;color:#1e40af;box-shadow:0 2px 6px rgba(96,165,250,0.3);border:none}
        .due-badge.future{background:#f1f5f9;color:#475569;box-shadow:0 2px 4px rgba(148,163,184,0.2);border:none}
        .due-date{font-size:12px;color:#475569;margin-top:4px;font-weight:500}
        .status-cell{position:relative}
        .status-badge{display:inline-block;padding:6px 10px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;border:2px solid transparent;transition:all 0.15s;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
        .status-badge:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        .status-dd{position:fixed;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.15);z-index:1000;min-width:200px;max-height:350px;overflow-y:auto;display:none}
        .status-dd.open{display:block}
        .status-opt{padding:12px 16px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:10px}
        .status-opt:hover{background:#f9fafb}
        .status-dot{width:10px;height:10px;border-radius:50%}
        .assignee-cell{position:relative}
        .assignee-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:25px;font-size:11px;cursor:pointer;font-weight:600;max-width:100%;transition:all 0.15s;border:2px solid transparent;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
        .assignee-badge:hover{transform:scale(1.03);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        .assignee-badge .init{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;flex-shrink:0;box-shadow:0 2px 6px rgba(0,0,0,0.2)}
        .assignee-badge .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .assignee-badge .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .assignee-dd{position:fixed;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.15);z-index:1000;width:300px;display:none}
        .assignee-dd.open{display:block}
        .assignee-dd input{width:100%;padding:12px 16px;border:none;border-bottom:1px solid #e5e7eb;font-size:14px;outline:none;border-radius:12px 12px 0 0}
        .assignee-list{max-height:280px;overflow-y:auto}
        .assignee-opt{padding:12px 16px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:12px}
        .assignee-opt:hover{background:#f9fafb}
        .assignee-opt .avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff}
        .premium-cell{text-align:right}
        .premium-main{font-size:14px;font-weight:800;color:#1e293b}
        .premium-exp{font-size:12px;color:#94a3b8;text-decoration:line-through}
        .premium-chg{font-size:12px;margin-top:2px;font-weight:700}
        .premium-chg.up{color:#dc2626}
        .premium-chg.down{color:#059669}
        .view-btn{width:32px;height:32px;border:none;border-radius:8px;background:#f1f5f9;cursor:pointer;font-size:14px;transition:all 0.15s;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
        .view-btn:hover{background:linear-gradient(135deg,#667eea,#764ba2);transform:scale(1.1);box-shadow:0 4px 12px rgba(102,126,234,0.4)}
        .pagination{padding:16px 24px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
        .page-btn{padding:8px 14px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer;font-size:14px}
        .page-btn.active{background:#764ba2;color:#fff;border-color:#764ba2}
        .page-btn:disabled{opacity:0.4;cursor:not-allowed}
        .panel-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:100;display:none}
        .panel-bg.open{display:block}
        .panel{position:fixed;top:0;right:-560px;width:560px;height:100%;background:#fff;z-index:101;transition:right 0.3s;display:flex;flex-direction:column}
        .panel.open{right:0}
        .panel-header{padding:24px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:flex-start}
        .panel-header h2{font-size:18px;font-weight:600;color:#111;line-height:1.4;max-width:450px}
        .panel-close{width:36px;height:36px;border:none;background:#f3f4f6;border-radius:10px;font-size:20px;cursor:pointer}
        .panel-body{flex:1;overflow-y:auto;padding:24px}
        .panel-footer{padding:20px 24px;border-top:1px solid #e5e7eb;display:flex;gap:12px;justify-content:flex-end}
        .section{margin-bottom:28px}
        .section h3{font-size:12px;font-weight:600;color:#6b7280;text-transform:uppercase;margin-bottom:16px}
        .field{margin-bottom:16px}
        .field label{display:block;font-size:13px;color:#4b5563;margin-bottom:6px;font-weight:500}
        .field input,.field select,.field textarea{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px;font-family:inherit}
        .field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:#764ba2}
        .field textarea{min-height:100px;resize:vertical}
        .autocomplete{position:relative}
        .autocomplete-dd{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #e5e7eb;border-top:none;border-radius:0 0 10px 10px;box-shadow:0 10px 30px rgba(0,0,0,0.1);max-height:250px;overflow-y:auto;z-index:10;display:none}
        .autocomplete-dd.open{display:block}
        .autocomplete-opt{padding:12px 14px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:12px}
        .autocomplete-opt:hover{background:#f9fafb}
        .autocomplete-opt .avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff}
        .btn{padding:12px 24px;border-radius:10px;font-size:14px;cursor:pointer;font-weight:600}
        .btn-cancel{background:#fff;border:1px solid #e5e7eb}
        .btn-save{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none}
        .loading{text-align:center;padding:80px;color:#6b7280}
        .spinner{width:48px;height:48px;border:4px solid #e5e7eb;border-top-color:#764ba2;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 20px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .toast{position:fixed;bottom:32px;right:32px;background:#333;color:#fff;padding:16px 24px;border-radius:12px;display:none;z-index:200;font-weight:500}
        .toast.show{display:block}
        .toast.ok{background:#059669}
        .toast.err{background:#dc2626}
        @media(max-width:1400px){.grid-header,.grid-row{grid-template-columns:minmax(180px,1.5fr) 70px 85px 85px 120px 140px 100px 38px;width:100%}.grid-header.billing,.grid-row.billing{grid-template-columns:minmax(160px,1.5fr) 70px 80px 80px 95px 95px 130px 95px 38px}}
        @media(max-width:1200px){.stats{grid-template-columns:repeat(3,1fr)}}
    </style>
</head>
<body>
    <div id="login" class="login-screen"><div class="login-card"><h1>üìã Policy Management</h1><p>Sign in with your Microsoft 365 account</p><button class="login-btn" onclick="signIn()">Sign In with Microsoft</button></div></div>
    <div id="app" class="app">
        <header class="header"><h1>üìã Policy Management</h1><div class="header-right"><div class="search-box"><input type="text" id="search" placeholder="Search policies..." oninput="filter()"></div><button class="new-btn" onclick="newPolicy()">+ New Policy</button><div class="user-badge" onclick="signOut()"><div class="avatar" id="userAvatar">?</div><span id="userName">User</span></div></div></header>
        <main class="main">
            <div class="stats">
                <div class="stat red" onclick="filterStat('pastDue')"><div class="num" id="sPastDue">0</div><div class="label">Past Due</div></div>
                <div class="stat orange" onclick="filterStat('dueWeek')"><div class="num" id="sDueWeek">0</div><div class="label">Due This Week</div></div>
                <div class="stat gray" onclick="filterStat('progress')"><div class="num" id="sProgress">0</div><div class="label">In Progress</div></div>
                <div class="stat teal" onclick="filterStat('billing')"><div class="num" id="sBilling">0</div><div class="label">In Billing</div></div>
                <div class="stat rose" onclick="filterStat('billPast')"><div class="num" id="sBillPast">0</div><div class="label">Billing Past Due</div></div>
                <div class="stat green" onclick="filterStat('unassign')"><div class="num" id="sUnassign">0</div><div class="label">Unassigned</div></div>
            </div>
            <div class="tabs">
                <div class="tab-row">
                    <div class="tab active" data-tab="myPolicy" onclick="switchTab('myPolicy')">üìã My Policies<span class="count" id="tMyPol">0</span></div>
                    <div class="tab" data-tab="myBilling" onclick="switchTab('myBilling')">üí∞ My Billing<span class="count" id="tMyBil">0</span></div>
                    <div class="tab-divider"></div>
                    <div class="tab" data-tab="allPolicy" onclick="switchTab('allPolicy')">üìã All Policies<span class="count" id="tAllPol">0</span></div>
                    <div class="tab" data-tab="allBilling" onclick="switchTab('allBilling')">üí∞ All Billing<span class="count" id="tAllBil">0</span></div>
                    <div class="tab" data-tab="archived" onclick="switchTab('archived')">üìÅ Archived<span class="count" id="tArch">0</span></div>
                </div>
                <div class="filters">
                    <select id="fStatus" onchange="filter()"><option value="">All Statuses</option></select>
                    <select id="fAssignee" onchange="filter()"><option value="">All Assignees</option></select>
                    <select id="fType" onchange="filter()"><option value="">All Types</option></select>
                    <select id="fBizType" onchange="filter()"><option value="">Business with Agency</option><option value="CL">CL - Commercial</option><option value="PL">PL - Personal</option></select>
                    <label><input type="checkbox" id="fUnassigned" onchange="filter()"> Unassigned Only</label>
                    <label><input type="checkbox" id="fShowAll" onchange="filter()"> Show All Dates</label>
                </div>
            </div>
            <div class="grid">
                <div class="grid-header" id="gridHeader"><div>POLICY</div><div>TYPE</div><div>EFF DATE</div><div>DUE DATE</div><div>STATUS</div><div>ASSIGNED TO</div><div style="text-align:right">PREMIUM</div><div></div></div>
                <div id="gridBody"><div class="loading"><div class="spinner"></div>Loading policies...</div></div>
                <div class="pagination" id="pagination" style="display:none"><div id="pageInfo"></div><div id="pageBtns"></div></div>
            </div>
        </main>
    </div>
    <div class="panel-bg" id="panelBg" onclick="closePanel()"></div>
    <div class="panel" id="panel"><div class="panel-header"><h2 id="panelTitle">Policy Details</h2><button class="panel-close" onclick="closePanel()">√ó</button></div><div class="panel-body" id="panelBody"></div><div class="panel-footer"><button class="btn btn-cancel" onclick="closePanel()">Cancel</button><button class="btn btn-save" onclick="save()">Save Changes</button></div></div>
    <div class="toast" id="toast"></div>
<script>
const CONFIG={clientId:'d2dbeace-3b37-4da9-85db-0bb4ca328f68',tenantId:'8b20613e-54c4-43a3-af63-92cdbf260edb',siteId:'9159d942-f331-4ac9-bd64-d609d016f38a',listId:'eb615fe6-0253-45b6-bab1-d436c553e5df',siteHost:'gancfried.sharepoint.com'};
const STATUSES=['Not Started','In-Progress','Pending ‚Äì Quote','Pending ‚Äì Customer','Pending ‚Äì Underwriting','Quote-Received','Bound-Direct Bill','Bound','Bound-New carrier','Lost','Replaced'];
const BILL_STATUSES=['Not Started','Invoice Sent','Payment Received','Closed'];
const COLORS={'Not Started':'#6b7280','In-Progress':'#2563eb','Pending ‚Äì Quote':'#7c3aed','Pending ‚Äì Customer':'#d97706','Pending ‚Äì Underwriting':'#db2777','Quote-Received':'#059669','Bound-Direct Bill':'#d97706','Bound':'#16a34a','Bound-New carrier':'#0891b2','Lost':'#dc2626','Replaced':'#6b7280','Invoice Sent':'#d97706','Payment Received':'#16a34a','Closed':'#6b7280'};
const EXIT=['Bound','Bound-Direct Bill','Bound-New carrier','Lost','Replaced'],PROGRESS=['In-Progress','Pending ‚Äì Quote','Pending ‚Äì Customer','Pending ‚Äì Underwriting','Quote-Received'],ACOLORS=['#dc2626','#ea580c','#d97706','#16a34a','#0891b2','#2563eb','#7c3aed','#c026d3'];
const msalConfig={auth:{clientId:CONFIG.clientId,authority:`https://login.microsoftonline.com/${CONFIG.tenantId}`,redirectUri:location.origin},cache:{cacheLocation:'sessionStorage'}};
let msal,user,token,currentUserId=null,policies=[],filtered=[],siteUsers=[],tab='myPolicy',selected=null,page=1,PAGE_SIZE=50,statFilter=null;
const F_ASSIGNED='AssignedTo0LookupId',F_NOTES='NextStep';

document.addEventListener('DOMContentLoaded',async()=>{msal=new window.msal.PublicClientApplication(msalConfig);await msal.initialize();const a=msal.getAllAccounts();if(a.length){user=a[0];await getToken();showApp()}STATUSES.forEach(s=>document.getElementById('fStatus').innerHTML+=`<option value="${s}">${s}</option>`);document.addEventListener('click',e=>{if(!e.target.closest('.status-cell')&&!e.target.closest('.status-dd'))document.querySelectorAll('.status-dd').forEach(d=>d.remove());if(!e.target.closest('.assignee-cell')&&!e.target.closest('.assignee-dd'))document.querySelectorAll('.assignee-dd').forEach(d=>d.remove());if(!e.target.closest('.autocomplete'))document.querySelectorAll('.autocomplete-dd').forEach(d=>d.classList.remove('open'))})});
async function signIn(){try{const r=await msal.loginPopup({scopes:['User.Read','User.ReadBasic.All','Sites.ReadWrite.All']});user=r.account;token=r.accessToken;showApp()}catch(e){console.error(e);toast('Login failed','err')}}
async function getToken(){try{const r=await msal.acquireTokenSilent({scopes:['User.Read','User.ReadBasic.All','Sites.ReadWrite.All'],account:user});token=r.accessToken}catch(e){const r=await msal.acquireTokenPopup({scopes:['User.Read','User.ReadBasic.All','Sites.ReadWrite.All']});token=r.accessToken}return token}
function signOut(){msal.logoutPopup()}
async function showApp(){document.getElementById('login').style.display='none';document.getElementById('app').style.display='block';const name=user.name||user.username||'User';document.getElementById('userName').textContent=name.split(' ')[0];document.getElementById('userAvatar').textContent=init(name);await loadSiteUsers();await loadPolicies()}
async function graph(url,opts={}){if(!token)await getToken();const r=await fetch(`https://graph.microsoft.com/v1.0${url}`,{...opts,headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}});if(!r.ok){const t=await r.text();console.error('Graph:',r.status,t);throw new Error(t)}return r.json()}

async function loadSiteUsers(){try{const r=await graph(`/sites/${CONFIG.siteHost},${CONFIG.siteId}/lists/User%20Information%20List/items?$expand=fields&$top=500`);siteUsers=r.value.map(u=>({id:String(u.fields.id),name:u.fields.Title||'',email:u.fields.EMail||''})).filter(u=>u.name);const email=user.username?.toLowerCase();const me=siteUsers.find(u=>u.email?.toLowerCase()===email);if(me)currentUserId=me.id;console.log('Current user:',currentUserId)}catch(e){console.log('Site users error:',e.message)}}

async function loadPolicies(){document.getElementById('gridBody').innerHTML='<div class="loading"><div class="spinner"></div>Loading policies...</div>';try{policies=[];let url=`/sites/${CONFIG.siteHost},${CONFIG.siteId}/lists/${CONFIG.listId}/items?$expand=fields&$top=999`;const types=new Set();while(url){const r=await graph(url);r.value.forEach(item=>{const f=item.fields;let assignedId=f[F_ASSIGNED]?String(f[F_ASSIGNED]):null,assignedName=null;if(assignedId){const u=siteUsers.find(su=>su.id===assignedId);if(u)assignedName=u.name}const pType=f.PolicyType||'';if(pType)types.add(pType);policies.push({id:item.id,Title:f.Title||'',PolicyNumber:f.PolicyNumber||'',PolicyType:pType,Carrier:f.Carrier||'',BizType:f.BusinessWithAgency||'',EffDate:f.EffectiveDate||'',ExpDate:f.ExpirationDate||'',ExpCost:f.ExpiringTotalCost,RenCost:f.RenewalTotalCost,DollarChg:f._x0024__x0020_Change,PctChg:f.PercentChange,Status:f.RenewalStatus||'Not Started',BillStatus:f.BillingStatus||'Not Started',Notes:f[F_NOTES]||'',IntNotes:f.InternalNotes||'',TransType:f.TransactionType||'Renewal',Archived:f.Archived||false,AssignedId:assignedId,AssignedName:assignedName})});url=r['@odata.nextLink']?r['@odata.nextLink'].replace('https://graph.microsoft.com/v1.0',''):null}const typeSelect=document.getElementById('fType');[...types].sort().forEach(t=>typeSelect.innerHTML+=`<option value="${t}">${t}</option>`);console.log('Loaded:',policies.length);buildAssigneeFilter();filter();updateStats()}catch(e){console.error('Load:',e);document.getElementById('gridBody').innerHTML='<div class="loading">Error loading policies</div>'}}

function buildAssigneeFilter(){const names=new Map();policies.forEach(p=>{if(p.AssignedId&&p.AssignedName)names.set(p.AssignedId,p.AssignedName)});const sel=document.getElementById('fAssignee');sel.innerHTML='<option value="">All Assignees</option>';[...names.entries()].sort((a,b)=>a[1].localeCompare(b[1])).forEach(([id,name])=>sel.innerHTML+=`<option value="${id}">${name}</option>`)}

// Parse date as local date (avoid timezone issues)
function parseLocalDate(dateStr){
    if(!dateStr)return null;
    const parts=dateStr.split('T')[0].split('-');
    return new Date(parseInt(parts[0]),parseInt(parts[1])-1,parseInt(parts[2]),0,0,0,0);
}

// Due date: For New Business use Effective Date, for Renewal use Expiration Date - 1 day
function getDue(p){
    if(p.TransType==='New Business'){
        return parseLocalDate(p.EffDate);
    }else{
        const exp=parseLocalDate(p.ExpDate);
        if(!exp)return null;
        exp.setDate(exp.getDate()-1);
        return exp;
    }
}

function getDueBadge(p){
    if(p.Archived)return null;
    const due=getDue(p);if(!due)return null;
    const today=new Date();today.setHours(0,0,0,0);
    const diff=Math.floor((due-today)/86400000);
    if(diff<0)return{text:'PAST DUE',cls:'past'};
    if(diff===0)return{text:'DUE TODAY',cls:'today'};
    if(diff===1)return{text:'DUE TOMORROW',cls:'soon'};
    if(diff<=7)return{text:`DUE IN ${diff} DAYS`,cls:'soon'};
    return{text:`DUE IN ${diff} DAYS`,cls:'future'};
}

function fmtShort(d){return d?d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):''}
function cur(v){return v!=null?'$'+Number(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):''}
function init(n){if(!n)return'?';const p=n.split(' ');return p.length>1?(p[0][0]+p[p.length-1][0]).toUpperCase():n.substring(0,2).toUpperCase()}
function acolor(id){return ACOLORS[Math.abs(Number(id)||0)%ACOLORS.length]}

function filter(){
    const search=document.getElementById('search').value.toLowerCase();
    const statusF=document.getElementById('fStatus').value;
    const assigneeF=document.getElementById('fAssignee').value;
    const typeF=document.getElementById('fType').value;
    const bizTypeF=document.getElementById('fBizType').value;
    const unassignedF=document.getElementById('fUnassigned').checked;
    const showAll=document.getElementById('fShowAll').checked;
    const isMyPolicy=tab==='myPolicy';
    const isMyBilling=tab==='myBilling';
    const isAllBilling=tab==='allBilling';
    const isArchived=tab==='archived';
    const isBilling=isMyBilling||isAllBilling;
    const isMy=isMyPolicy||isMyBilling;
    
    const today=new Date();today.setHours(0,0,0,0);
    const past30=new Date(today);past30.setDate(past30.getDate()-30);
    const future90=new Date(today);future90.setDate(future90.getDate()+90);
    const week=new Date(today);week.setDate(week.getDate()+7);
    
    filtered=policies.filter(p=>{
        // For archived tab, only show archived items but still apply search/filters
        if(isArchived){
            if(!p.Archived)return false;
            // Apply search to archived items
            if(search){const txt=[p.Title,p.PolicyNumber,p.Carrier,p.Notes,p.AssignedName].join(' ').toLowerCase();if(!txt.includes(search))return false}
            if(statusF&&p.Status!==statusF)return false;
            if(assigneeF&&p.AssignedId!==assigneeF)return false;
            if(typeF&&p.PolicyType!==typeF)return false;
            if(bizTypeF&&p.BizType!==bizTypeF)return false;
            if(unassignedF&&p.AssignedId)return false;
            return true;
        }
        if(p.Archived)return false;
        if(isMy&&p.AssignedId!==currentUserId)return false;
        if(!showAll&&p.ExpDate){
            const exp=parseLocalDate(p.ExpDate);
            if(exp&&(exp<past30||exp>future90))return false;
        }
        if(isBilling){
            if(!['Bound','Bound-New carrier'].includes(p.Status))return false;
            if(['Payment Received','Closed'].includes(p.BillStatus))return false;
        }else if(!isArchived){
            if(EXIT.includes(p.Status))return false;
        }
        
        // Stat card filters - STRICT matching
        if(statFilter){
            const due=getDue(p);
            const isPol=!EXIT.includes(p.Status);
            const isBil=['Bound','Bound-New carrier'].includes(p.Status)&&!['Payment Received','Closed'].includes(p.BillStatus);
            
            if(statFilter==='pastDue'){
                // ONLY policies with due date BEFORE today
                if(!isPol||!due||due>=today)return false;
            }
            if(statFilter==='dueWeek'){
                // ONLY policies with due date from TODAY through END of this week (7 days)
                if(!isPol||!due||due<today||due>=week)return false;
            }
            if(statFilter==='progress'){
                // ONLY policies with IN PROGRESS statuses (NOT "Not Started")
                if(!isPol||!PROGRESS.includes(p.Status))return false;
            }
            if(statFilter==='billing'){
                if(!isBil)return false;
            }
            if(statFilter==='billPast'){
                // ONLY billing items with due date BEFORE today
                if(!isBil||!due||due>=today)return false;
            }
            if(statFilter==='unassign'){
                const exp=parseLocalDate(p.ExpDate);
                if(!(!p.AssignedId&&exp&&exp>=today&&exp<=future90))return false;
            }
        }
        
        if(search){const txt=[p.Title,p.PolicyNumber,p.Carrier,p.Notes,p.AssignedName].join(' ').toLowerCase();if(!txt.includes(search))return false}
        if(statusF&&p.Status!==statusF)return false;
        if(assigneeF&&p.AssignedId!==assigneeF)return false;
        if(typeF&&p.PolicyType!==typeF)return false;
        if(bizTypeF&&p.BizType!==bizTypeF)return false;
        if(unassignedF&&p.AssignedId)return false;
        return true;
    });
    filtered.sort((a,b)=>{const dA=getDue(a),dB=getDue(b);if(!dA)return 1;if(!dB)return -1;return dA-dB});
    page=1;render();updateTabCounts();
}

function render(){
    const body=document.getElementById('gridBody');
    const total=filtered.length;
    const pages=Math.ceil(total/PAGE_SIZE);
    const start=(page-1)*PAGE_SIZE;
    const items=filtered.slice(start,start+PAGE_SIZE);
    const isBillingTab=tab==='myBilling'||tab==='allBilling';
    
    // Update header for billing (includes both Policy Status and Billing Status)
    const header=document.getElementById('gridHeader');
    if(isBillingTab){
        header.className='grid-header billing';
        header.innerHTML='<div>POLICY</div><div>TYPE</div><div>EFF DATE</div><div>DUE DATE</div><div>POLICY STATUS</div><div>BILLING STATUS</div><div>ASSIGNED TO</div><div style="text-align:right">PREMIUM</div><div></div>';
    }else{
        header.className='grid-header';
        header.innerHTML='<div>POLICY</div><div>TYPE</div><div>EFF DATE</div><div>DUE DATE</div><div>STATUS</div><div>ASSIGNED TO</div><div style="text-align:right">PREMIUM</div><div></div>';
    }
    
    if(!items.length){body.innerHTML='<div class="loading">No policies found</div>';document.getElementById('pagination').style.display='none';return}
    
    body.innerHTML=items.map((p,idx)=>{
        const badge=getDueBadge(p);
        const due=getDue(p);
        const effDate=parseLocalDate(p.EffDate);
        const color=COLORS[p.Status]||'#666';
        const billColor=COLORS[p.BillStatus]||'#666';
        const aName=p.AssignedName||'Unassigned';
        const ac=p.AssignedId?acolor(p.AssignedId):'#9ca3af';
        const icon=p.TransType==='New Business'?'‚ú®':'üîÑ';
        const hasChange=p.DollarChg||p.PctChg!=null;
        
        // Premium display - determine if it's a decrease based on actual costs
        const isDecrease = p.ExpCost!=null && p.RenCost!=null && p.RenCost < p.ExpCost;
        let premiumHtml;
        if(hasChange&&p.RenCost!=null){
            premiumHtml=`${p.ExpCost!=null?`<div class="premium-exp">${cur(p.ExpCost)}</div>`:''}
                <div class="premium-main">${cur(p.RenCost)}</div>
                ${p.DollarChg?`<div class="premium-chg ${isDecrease?'down':'up'}">${p.DollarChg}</div>`:''}
                ${p.PctChg!=null?`<div class="premium-chg ${p.PctChg<0?'down':'up'}">(${p.PctChg>0?'+':''}${Math.round(p.PctChg)}%)</div>`:''}`;
        }else{
            const showAmt=p.ExpCost!=null?p.ExpCost:p.RenCost;
            premiumHtml=`<div class="premium-main">${cur(showAmt)}</div>`;
        }
        
        // Transaction type badge
        const transColor = p.TransType==='New Business'?'#7c3aed':'#0891b2';
        const transLabel = p.TransType==='New Business'?'New':'Renewal';
        
        if(isBillingTab){
            return `<div class="grid-row billing" onclick="openPanel('${p.id}')">
                <div class="policy-cell">
                    <div class="policy-icon" style="background:${color}15;color:${color}">${icon}</div>
                    <div class="policy-info">
                        <h3>${p.Title}</h3>
                        <div class="meta">${p.PolicyNumber}${p.PolicyType?' ‚Ä¢ '+p.PolicyType:''}${p.BizType?' ‚Ä¢ '+p.BizType:''}</div>
                        ${p.Carrier?`<div class="carrier">üè¢ ${p.Carrier}</div>`:''}
                        ${p.Notes?`<div class="notes">üìù ${p.Notes.length>30?p.Notes.substring(0,30)+'...':p.Notes}</div>`:''}
                    </div>
                </div>
                <div class="trans-cell"><span class="trans-badge" style="background:${transColor}15;color:${transColor}">${transLabel}</span></div>
                <div class="date-cell">${effDate?fmtShort(effDate):'-'}</div>
                <div class="due-cell">
                    ${badge?`<div class="due-badge ${badge.cls}">${badge.text}</div>`:''}
                    <div class="due-date">${due?fmtShort(due):''}</div>
                </div>
                <div class="status-cell">
                    <div class="status-badge" style="background:${color}15;color:${color}" onclick="event.stopPropagation();toggleStatus('${p.id}',false,this)">${p.Status}</div>
                </div>
                <div class="status-cell">
                    <div class="status-badge" style="background:${billColor}15;color:${billColor}" onclick="event.stopPropagation();toggleStatus('${p.id}',true,this)">${p.BillStatus}</div>
                </div>
                <div class="assignee-cell">
                    <div class="assignee-badge" style="background:${ac}15;color:${ac}" onclick="event.stopPropagation();toggleAssignee('${p.id}',this)">
                        <div class="init" style="background:${ac}">${init(aName)}</div>
                        <span class="name">${aName}</span>
                    </div>
                </div>
                <div class="premium-cell">${premiumHtml}</div>
                <div><button class="view-btn" onclick="event.stopPropagation();openPanel('${p.id}')">üëÅ</button></div>
            </div>`;
        }else{
            return `<div class="grid-row" onclick="openPanel('${p.id}')">
                <div class="policy-cell">
                    <div class="policy-icon" style="background:${color}15;color:${color}">${icon}</div>
                    <div class="policy-info">
                        <h3>${p.Title}</h3>
                        <div class="meta">${p.PolicyNumber}${p.PolicyType?' ‚Ä¢ '+p.PolicyType:''}${p.BizType?' ‚Ä¢ '+p.BizType:''}</div>
                        ${p.Carrier?`<div class="carrier">üè¢ ${p.Carrier}</div>`:''}
                        ${p.Notes?`<div class="notes">üìù ${p.Notes.length>30?p.Notes.substring(0,30)+'...':p.Notes}</div>`:''}
                    </div>
                </div>
                <div class="trans-cell"><span class="trans-badge" style="background:${transColor}15;color:${transColor}">${transLabel}</span></div>
                <div class="date-cell">${effDate?fmtShort(effDate):'-'}</div>
                <div class="due-cell">
                    ${badge?`<div class="due-badge ${badge.cls}">${badge.text}</div>`:''}
                    <div class="due-date">${due?fmtShort(due):''}</div>
                </div>
                <div class="status-cell">
                    <div class="status-badge" style="background:${color}15;color:${color}" onclick="event.stopPropagation();toggleStatus('${p.id}',false,this)">${p.Status}</div>
                </div>
                <div class="assignee-cell">
                    <div class="assignee-badge" style="background:${ac}15;color:${ac}" onclick="event.stopPropagation();toggleAssignee('${p.id}',this)">
                        <div class="init" style="background:${ac}">${init(aName)}</div>
                        <span class="name">${aName}</span>
                    </div>
                </div>
                <div class="premium-cell">${premiumHtml}</div>
                <div><button class="view-btn" onclick="event.stopPropagation();openPanel('${p.id}')">üëÅ</button></div>
            </div>`;
        }
    }).join('');
    
    const pag=document.getElementById('pagination');
    if(pages>1){
        pag.style.display='flex';
        document.getElementById('pageInfo').textContent=`Showing ${start+1}-${Math.min(start+PAGE_SIZE,total)} of ${total}`;
        let btns=`<button class="page-btn" onclick="goPage(${page-1})" ${page===1?'disabled':''}>‚Üê Prev</button>`;
        for(let i=Math.max(1,page-2);i<=Math.min(pages,page+2);i++)btns+=`<button class="page-btn ${i===page?'active':''}" onclick="goPage(${i})">${i}</button>`;
        btns+=`<button class="page-btn" onclick="goPage(${page+1})" ${page===pages?'disabled':''}>Next ‚Üí</button>`;
        document.getElementById('pageBtns').innerHTML=btns;
    }else{pag.style.display='none'}
}

function goPage(p){if(p<1||p>Math.ceil(filtered.length/PAGE_SIZE))return;page=p;render();window.scrollTo(0,0)}

function toggleStatus(id,isBilling,el){
    document.querySelectorAll('.status-dd').forEach(d=>d.remove());
    const rect=el.getBoundingClientRect();
    const dd=document.createElement('div');
    dd.className='status-dd open';
    const spaceBelow=window.innerHeight-rect.bottom;
    const ddHeight=isBilling?180:400;
    if(spaceBelow<ddHeight){dd.style.bottom=(window.innerHeight-rect.top+6)+'px';}
    else{dd.style.top=(rect.bottom+6)+'px';}
    dd.style.left=rect.left+'px';
    const statuses=isBilling?BILL_STATUSES:STATUSES;
    dd.innerHTML=statuses.map(s=>`<div class="status-opt" onclick="event.stopPropagation();setStatus('${id}','${s}',${isBilling})"><div class="status-dot" style="background:${COLORS[s]||'#6b7280'}"></div>${s}</div>`).join('');
    document.body.appendChild(dd);
}

async function setStatus(id,status,isBilling){
    document.querySelectorAll('.status-dd').forEach(d=>d.remove());
    try{
        const field=isBilling?{BillingStatus:status}:{RenewalStatus:status};
        await graph(`/sites/${CONFIG.siteHost},${CONFIG.siteId}/lists/${CONFIG.listId}/items/${id}/fields`,{method:'PATCH',body:JSON.stringify(field)});
        const p=policies.find(x=>x.id===id);
        if(p){if(isBilling)p.BillStatus=status;else p.Status=status}
        toast('Status updated','ok');
        filter();updateStats();
    }catch(e){toast('Update failed','err')}
}

function toggleAssignee(id,el){
    document.querySelectorAll('.assignee-dd').forEach(d=>d.remove());
    const rect=el.getBoundingClientRect();
    const dd=document.createElement('div');
    dd.className='assignee-dd open';
    const spaceBelow=window.innerHeight-rect.bottom;
    if(spaceBelow<320){dd.style.bottom=(window.innerHeight-rect.top+6)+'px';}
    else{dd.style.top=(rect.bottom+6)+'px';}
    dd.style.left=Math.min(rect.left,window.innerWidth-320)+'px';
    dd.innerHTML=`<input type="text" placeholder="Search users..." oninput="searchGridUsersDD(this,'${id}')" onclick="event.stopPropagation()"><div class="assignee-list" id="al-dd-${id}"></div>`;
    document.body.appendChild(dd);
    dd.querySelector('input').focus();
    renderGridUserListDD(id,siteUsers.slice(0,12));
}

let gridSearchTimeout=null;
function searchGridUsersDD(input,policyId){
    const q=input.value.trim().toLowerCase();
    if(q.length<2){renderGridUserListDD(policyId,siteUsers.slice(0,12));return}
    const siteMatches=siteUsers.filter(u=>u.name.toLowerCase().includes(q));
    renderGridUserListDD(policyId,siteMatches.slice(0,12));
    clearTimeout(gridSearchTimeout);
    gridSearchTimeout=setTimeout(async()=>{
        try{
            const r=await graph(`/users?$filter=startswith(displayName,'${encodeURIComponent(q)}')&$select=id,displayName,mail&$top=10`);
            const azUsers=r.value.map(u=>({id:u.id,name:u.displayName,email:u.mail,isAzure:true}));
            const combined=[...siteMatches.map(u=>({...u,isAzure:false}))];
            azUsers.forEach(au=>{if(!combined.find(su=>su.name.toLowerCase()===au.name.toLowerCase()))combined.push(au)});
            renderGridUserListDD(policyId,combined.slice(0,12));
        }catch(e){console.error(e)}
    },300);
}

function renderGridUserListDD(policyId,users){
    const list=document.getElementById(`al-dd-${policyId}`);
    if(!list)return;
    list.innerHTML=`<div class="assignee-opt" onclick="setGridAssigneeDD('${policyId}','','',true)"><div class="avatar" style="background:#9ca3af">?</div>Unassigned</div>`+users.map(u=>{
        const isAzure=u.isAzure||!/^\d+$/.test(u.id);
        return `<div class="assignee-opt" onclick="setGridAssigneeDD('${policyId}','${u.id}','${u.name.replace(/'/g,"\\'")}',${!isAzure})"><div class="avatar" style="background:${acolor(u.id)}">${init(u.name)}</div><div style="flex:1;min-width:0"><div style="font-weight:500">${u.name}</div>${u.email?`<div style="font-size:11px;color:#9ca3af;overflow:hidden;text-overflow:ellipsis">${u.email}</div>`:''}${isAzure?`<div style="font-size:10px;color:#f59e0b">‚ö† Not in SharePoint</div>`:''}</div></div>`;
    }).join('');
}

async function setGridAssigneeDD(policyId,userId,userName,isSiteUser){
    document.querySelectorAll('.assignee-dd').forEach(d=>d.remove());
    if(userId&&!isSiteUser){toast('Add to SharePoint first','err');return}
    try{
        const fields={};fields[F_ASSIGNED]=userId?parseInt(userId):null;
        await graph(`/sites/${CONFIG.siteHost},${CONFIG.siteId}/lists/${CONFIG.listId}/items/${policyId}/fields`,{method:'PATCH',body:JSON.stringify(fields)});
        const p=policies.find(x=>x.id===policyId);
        if(p){p.AssignedId=userId||null;p.AssignedName=userName||null}
        toast('Assignee updated','ok');
        buildAssigneeFilter();filter();updateStats();
    }catch(e){console.error(e);toast('Update failed','err')}
}

function updateStats(){
    const today=new Date();today.setHours(0,0,0,0);
    const week=new Date(today);week.setDate(week.getDate()+7);
    const f90=new Date(today);f90.setDate(f90.getDate()+90);
    let pd=0,dw=0,ip=0,bl=0,bp=0,ua=0;
    policies.forEach(p=>{
        if(p.Archived)return;
        const due=getDue(p);
        const exp=parseLocalDate(p.ExpDate);
        const isPol=!EXIT.includes(p.Status);
        const isBil=['Bound','Bound-New carrier'].includes(p.Status)&&!['Payment Received','Closed'].includes(p.BillStatus);
        // Past due: due date BEFORE today
        if(isPol&&due&&due<today)pd++;
        // Due this week: due date from TODAY through 6 days from now (NOT past due)
        if(isPol&&due&&due>=today&&due<week)dw++;
        // In progress: ONLY in PROGRESS statuses
        if(isPol&&PROGRESS.includes(p.Status))ip++;
        // Billing
        if(isBil){bl++;if(due&&due<today)bp++}
        // Unassigned
        if(!p.AssignedId&&exp&&exp>=today&&exp<=f90)ua++;
    });
    document.getElementById('sPastDue').textContent=pd;
    document.getElementById('sDueWeek').textContent=dw;
    document.getElementById('sProgress').textContent=ip;
    document.getElementById('sBilling').textContent=bl;
    document.getElementById('sBillPast').textContent=bp;
    document.getElementById('sUnassign').textContent=ua;
}

function updateTabCounts(){
    const today=new Date();today.setHours(0,0,0,0);
    const past30=new Date(today);past30.setDate(past30.getDate()-30);
    const f90=new Date(today);f90.setDate(f90.getDate()+90);
    const showAll=document.getElementById('fShowAll').checked;
    let mp=0,mb=0,ap=0,ab=0,ar=0;
    policies.forEach(p=>{
        if(p.Archived){ar++;return}
        if(!showAll&&p.ExpDate){const exp=parseLocalDate(p.ExpDate);if(exp&&(exp<past30||exp>f90))return}
        const isPol=!EXIT.includes(p.Status),isBil=['Bound','Bound-New carrier'].includes(p.Status)&&!['Payment Received','Closed'].includes(p.BillStatus);
        if(isPol){ap++;if(p.AssignedId===currentUserId)mp++}
        if(isBil){ab++;if(p.AssignedId===currentUserId)mb++}
    });
    document.getElementById('tMyPol').textContent=mp;
    document.getElementById('tMyBil').textContent=mb;
    document.getElementById('tAllPol').textContent=ap;
    document.getElementById('tAllBil').textContent=ab;
    document.getElementById('tArch').textContent=ar;
}

function switchTab(t,preserveStatFilter){tab=t;if(!preserveStatFilter)statFilter=null;document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active',x.dataset.tab===t));filter()}

function filterStat(stat){
    statFilter=stat;
    document.getElementById('fStatus').value='';
    document.getElementById('fAssignee').value='';
    document.getElementById('fType').value='';
    document.getElementById('fBizType').value='';
    document.getElementById('fUnassigned').checked=false;
    if(stat==='billing'||stat==='billPast')switchTab('allBilling',true);
    else switchTab('allPolicy',true);
}

function newPolicy(){
    selected=null;
    document.getElementById('panelTitle').textContent='New Policy';
    document.getElementById('panelBody').innerHTML=`
        <div class="section"><h3>Policy Information</h3>
            <div class="field"><label>Title</label><input id="pTitle" placeholder="Customer Name | Policy Number | Type"></div>
            <div class="field"><label>Policy Number</label><input id="pNum" placeholder="Policy number"></div>
            <div class="field"><label>Carrier / Company</label><input id="pCarrier" placeholder="Carrier name"></div>
            <div class="field"><label>Policy Type</label><input id="pPolicyType" placeholder="e.g. Commercial Property"></div>
            <div class="field"><label>Business with Agency</label><select id="pBizType"><option value="">Select...</option><option value="CL">CL - Commercial</option><option value="PL">PL - Personal</option></select></div>
            <div class="field"><label>Transaction Type</label><select id="pTransType"><option value="Renewal">Renewal</option><option value="New Business">New Business</option></select></div>
        </div>
        <div class="section"><h3>Dates</h3>
            <div class="field"><label>Effective Date</label><input type="date" id="pEff"></div>
            <div class="field"><label>Expiration Date</label><input type="date" id="pExp"></div>
        </div>
        <div class="section"><h3>Policy Status</h3>
            <div class="field"><label>Renewal Status</label><select id="pStatus">${STATUSES.map(s=>`<option value="${s}">${s}</option>`).join('')}</select></div>
            <div class="field"><label>Billing Status</label><select id="pBillStatus">${BILL_STATUSES.map(s=>`<option value="${s}">${s}</option>`).join('')}</select></div>
            <div class="field"><label>Assigned To</label>
                <div class="autocomplete">
                    <input type="text" id="pAssignName" placeholder="Search users..." oninput="searchPanelUsers(this.value)" onfocus="searchPanelUsers(this.value)">
                    <input type="hidden" id="pAssignId">
                    <input type="hidden" id="pAssignIsSite" value="true">
                    <div class="autocomplete-dd" id="panelUserDD"></div>
                </div>
            </div>
        </div>
        <div class="section"><h3>Premium</h3>
            <div class="field"><label>Expiring Premium</label><input type="number" id="pExpCost" step="0.01" placeholder="0.00"></div>
            <div class="field"><label>Renewal Premium</label><input type="number" id="pRenCost" step="0.01" placeholder="0.00"></div>
        </div>
        <div class="section"><h3>Notes</h3>
            <div class="field"><label>Notes</label><textarea id="pNotes" placeholder="Enter notes..."></textarea></div>
            <div class="field"><label>Internal Notes</label><textarea id="pIntNotes" placeholder="Internal notes..."></textarea></div>
        </div>`;
    document.getElementById('panel').classList.add('open');
    document.getElementById('panelBg').classList.add('open');
}

function openPanel(id){
    selected=policies.find(p=>p.id===id);if(!selected)return;
    document.getElementById('panelTitle').textContent=selected.Title;
    document.getElementById('panelBody').innerHTML=`
        <div class="section"><h3>Policy Information</h3>
            <div class="field"><label>Title</label><input id="pTitle" value="${selected.Title.replace(/"/g,'&quot;')}"></div>
            <div class="field"><label>Policy Number</label><input id="pNum" value="${selected.PolicyNumber}"></div>
            <div class="field"><label>Carrier / Company</label><input id="pCarrier" value="${(selected.Carrier||'').replace(/"/g,'&quot;')}"></div>
            <div class="field"><label>Policy Type</label><input id="pPolicyType" value="${selected.PolicyType||''}"></div>
            <div class="field"><label>Business with Agency</label><select id="pBizType"><option value="">Select...</option><option value="CL" ${selected.BizType==='CL'?'selected':''}>CL - Commercial</option><option value="PL" ${selected.BizType==='PL'?'selected':''}>PL - Personal</option></select></div>
            <div class="field"><label>Transaction Type</label><select id="pTransType"><option value="Renewal" ${selected.TransType==='Renewal'?'selected':''}>Renewal</option><option value="New Business" ${selected.TransType==='New Business'?'selected':''}>New Business</option></select></div>
        </div>
        <div class="section"><h3>Dates</h3>
            <div class="field"><label>Effective Date</label><input type="date" id="pEff" value="${selected.EffDate?selected.EffDate.split('T')[0]:''}"></div>
            <div class="field"><label>Expiration Date</label><input type="date" id="pExp" value="${selected.ExpDate?selected.ExpDate.split('T')[0]:''}"></div>
        </div>
        <div class="section"><h3>Policy Status</h3>
            <div class="field"><label>Renewal Status</label><select id="pStatus">${STATUSES.map(s=>`<option value="${s}" ${selected.Status===s?'selected':''}>${s}</option>`).join('')}</select></div>
            <div class="field"><label>Billing Status</label><select id="pBillStatus">${BILL_STATUSES.map(s=>`<option value="${s}" ${selected.BillStatus===s?'selected':''}>${s}</option>`).join('')}</select></div>
            <div class="field"><label>Assigned To</label>
                <div class="autocomplete">
                    <input type="text" id="pAssignName" value="${selected.AssignedName||''}" placeholder="Search users..." oninput="searchPanelUsers(this.value)" onfocus="searchPanelUsers(this.value)">
                    <input type="hidden" id="pAssignId" value="${selected.AssignedId||''}">
                    <input type="hidden" id="pAssignIsSite" value="true">
                    <div class="autocomplete-dd" id="panelUserDD"></div>
                </div>
            </div>
        </div>
        <div class="section"><h3>Premium</h3>
            <div class="field"><label>Expiring Premium</label><input type="number" id="pExpCost" step="0.01" value="${selected.ExpCost||''}"></div>
            <div class="field"><label>Renewal Premium</label><input type="number" id="pRenCost" step="0.01" value="${selected.RenCost||''}"></div>
        </div>
        <div class="section"><h3>Notes</h3>
            <div class="field"><label>Notes</label><textarea id="pNotes">${selected.Notes||''}</textarea></div>
            <div class="field"><label>Internal Notes</label><textarea id="pIntNotes">${selected.IntNotes||''}</textarea></div>
        </div>
        <div class="section"><h3>Other</h3>
            <div class="field"><label>Archived</label><select id="pArch"><option value="false" ${!selected.Archived?'selected':''}>No</option><option value="true" ${selected.Archived?'selected':''}>Yes</option></select></div>
        </div>`;
    document.getElementById('panel').classList.add('open');
    document.getElementById('panelBg').classList.add('open');
}

let panelSearchTimeout=null;
async function searchPanelUsers(q){const dd=document.getElementById('panelUserDD');q=q.trim().toLowerCase();if(q.length<2){dd.innerHTML=`<div class="autocomplete-opt" onclick="selectPanelUser('','',true)"><div class="avatar" style="background:#9ca3af">?</div>Unassigned</div>`+siteUsers.slice(0,10).map(u=>`<div class="autocomplete-opt" onclick="selectPanelUser('${u.id}','${u.name.replace(/'/g,"\\'")}',true)"><div class="avatar" style="background:${acolor(u.id)}">${init(u.name)}</div>${u.name}</div>`).join('');dd.classList.add('open');return}const siteMatches=siteUsers.filter(u=>u.name.toLowerCase().includes(q));dd.innerHTML=`<div class="autocomplete-opt" onclick="selectPanelUser('','',true)"><div class="avatar" style="background:#9ca3af">?</div>Unassigned</div>`+siteMatches.slice(0,10).map(u=>`<div class="autocomplete-opt" onclick="selectPanelUser('${u.id}','${u.name.replace(/'/g,"\\'")}',true)"><div class="avatar" style="background:${acolor(u.id)}">${init(u.name)}</div>${u.name}</div>`).join('');dd.classList.add('open');clearTimeout(panelSearchTimeout);panelSearchTimeout=setTimeout(async()=>{try{const r=await graph(`/users?$filter=startswith(displayName,'${encodeURIComponent(q)}')&$select=id,displayName,mail&$top=10`);const azUsers=r.value.map(u=>({id:u.id,name:u.displayName,email:u.mail}));const combined=[...siteMatches.map(u=>({...u,isSite:true}))];azUsers.forEach(au=>{if(!combined.find(su=>su.name.toLowerCase()===au.name.toLowerCase()))combined.push({...au,isSite:false})});dd.innerHTML=`<div class="autocomplete-opt" onclick="selectPanelUser('','',true)"><div class="avatar" style="background:#9ca3af">?</div>Unassigned</div>`+combined.slice(0,15).map(u=>`<div class="autocomplete-opt" onclick="selectPanelUser('${u.id}','${u.name.replace(/'/g,"\\'")}',${u.isSite!==false})"><div class="avatar" style="background:${acolor(u.id)}">${init(u.name)}</div><div><div>${u.name}</div>${u.email?`<div style="font-size:11px;color:#9ca3af">${u.email}</div>`:''}${u.isSite===false?`<div style="font-size:10px;color:#f59e0b">‚ö† Not in SharePoint</div>`:''}</div></div>`).join('')}catch(e){console.error(e)}},300)}

function selectPanelUser(id,name,isSite){document.getElementById('pAssignId').value=id;document.getElementById('pAssignName').value=name;document.getElementById('pAssignIsSite').value=isSite?'true':'false';document.getElementById('panelUserDD').classList.remove('open')}
function closePanel(){document.getElementById('panel').classList.remove('open');document.getElementById('panelBg').classList.remove('open');selected=null}

async function save(){
    const assignId=document.getElementById('pAssignId').value;
    const isSiteUser=document.getElementById('pAssignIsSite').value==='true';
    if(assignId&&!isSiteUser){toast('Add to SharePoint first','err');return}
    try{
        const fields={
            Title:document.getElementById('pTitle').value,
            PolicyNumber:document.getElementById('pNum').value,
            Carrier:document.getElementById('pCarrier').value,
            PolicyType:document.getElementById('pPolicyType')?.value||'',
            BusinessWithAgency:document.getElementById('pBizType')?.value||'',
            TransactionType:document.getElementById('pTransType').value,
            EffectiveDate:document.getElementById('pEff').value||null,
            ExpirationDate:document.getElementById('pExp').value||null,
            RenewalStatus:document.getElementById('pStatus').value,
            BillingStatus:document.getElementById('pBillStatus')?.value||'Not Started',
            ExpiringTotalCost:parseFloat(document.getElementById('pExpCost').value)||null,
            RenewalTotalCost:parseFloat(document.getElementById('pRenCost').value)||null,
            InternalNotes:document.getElementById('pIntNotes').value
        };
        fields[F_NOTES]=document.getElementById('pNotes').value;
        fields[F_ASSIGNED]=assignId?parseInt(assignId):null;
        const archEl=document.getElementById('pArch');
        if(archEl)fields.Archived=archEl.value==='true';
        
        if(selected){
            await graph(`/sites/${CONFIG.siteHost},${CONFIG.siteId}/lists/${CONFIG.listId}/items/${selected.id}/fields`,{method:'PATCH',body:JSON.stringify(fields)});
            Object.assign(selected,{Title:fields.Title,PolicyNumber:fields.PolicyNumber,Carrier:fields.Carrier,PolicyType:fields.PolicyType,BizType:fields.BusinessWithAgency,TransType:fields.TransactionType,EffDate:fields.EffectiveDate,ExpDate:fields.ExpirationDate,Status:fields.RenewalStatus,BillStatus:fields.BillingStatus,ExpCost:fields.ExpiringTotalCost,RenCost:fields.RenewalTotalCost,Notes:fields[F_NOTES],IntNotes:fields.InternalNotes,Archived:fields.Archived,AssignedId:assignId||null,AssignedName:document.getElementById('pAssignName').value||null});
        }else{
            const r=await graph(`/sites/${CONFIG.siteHost},${CONFIG.siteId}/lists/${CONFIG.listId}/items`,{method:'POST',body:JSON.stringify({fields})});
            policies.push({id:r.id,Title:fields.Title,PolicyNumber:fields.PolicyNumber,PolicyType:fields.PolicyType,Carrier:fields.Carrier,BizType:fields.BusinessWithAgency,EffDate:fields.EffectiveDate,ExpDate:fields.ExpirationDate,ExpCost:fields.ExpiringTotalCost,RenCost:fields.RenewalTotalCost,DollarChg:null,PctChg:null,Status:fields.RenewalStatus,BillStatus:fields.BillingStatus,Notes:fields[F_NOTES],IntNotes:fields.InternalNotes,TransType:fields.TransactionType,Archived:false,AssignedId:assignId||null,AssignedName:document.getElementById('pAssignName').value||null});
        }
        toast(selected?'Saved!':'Policy created!','ok');
        closePanel();buildAssigneeFilter();filter();updateStats();
    }catch(e){console.error('Save:',e);toast('Save failed','err')}
}

function toast(msg,type){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(()=>t.classList.remove('show'),3000)}
</script>
</body>
</html>
