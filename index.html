<!DOCTYPE html>
<!-- Version 70 - Added AMS360 Status dropdown filter -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Policy Management</title>
    <script>
    // ONE-TIME FORCE REFRESH - Change this number to force all users to refresh
    var FORCE_REFRESH_VERSION = 70;
    (function(){
        var key = 'pm_force_refresh_v';
        var lastForced = localStorage.getItem(key);
        if(!lastForced || parseInt(lastForced) < FORCE_REFRESH_VERSION){
            localStorage.setItem(key, FORCE_REFRESH_VERSION);
            // Only force refresh if this isn't already a cache-busted request
            if(location.search.indexOf('_forceRefresh=') === -1){
                location.replace(location.pathname + '?_forceRefresh=' + FORCE_REFRESH_VERSION + '&_t=' + Date.now());
            }
        }
    })();
    </script>
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(180deg,#f8fafc 0%,#e2e8f0 100%);min-height:100vh;font-size:14px}
        .hidden{display:none !important}
        .app{display:none;padding:24px;max-width:1400px;margin:0 auto}
        .login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%)}
        .login-card{background:#fff;padding:48px;border-radius:16px;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,0.25);max-width:400px}
        .login-card h1{font-size:24px;margin-bottom:8px;color:#1e293b;font-weight:700}
        .login-card p{color:#64748b;margin-bottom:32px;font-size:14px}
        .login-btn{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;border:none;padding:14px 32px;border-radius:8px;font-size:14px;cursor:pointer;font-weight:600;transition:all 0.2s}
        .login-btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(59,130,246,0.4)}
        
        /* Header - Dark gradient like PLM */
        .header{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);color:#fff;padding:24px 32px;border-radius:12px;margin-bottom:24px;display:none;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px}
        .header.visible{display:flex}
        .header-left h1{font-size:24px;font-weight:700;display:flex;align-items:center;gap:12px;margin:0}
        .header-left p{margin:4px 0 0;opacity:0.9;font-size:14px}
        .header-right{display:flex;gap:12px;align-items:center}
        .header-welcome{font-size:14px;opacity:0.9}
        .search-box{position:relative}
        .search-box input{padding:10px 16px 10px 40px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);width:220px;font-size:13px;background:rgba(255,255,255,0.1);color:#fff}
        .search-box input::placeholder{color:rgba(255,255,255,0.6)}
        .search-box:before{content:'üîç';position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:12px}
        .new-btn{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;border:none;padding:10px 18px;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;transition:all 0.2s}
        .new-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,0.4)}
        .signout-btn{padding:8px 16px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.2);border-radius:8px;cursor:pointer;font-size:13px;transition:all 0.2s}
        .signout-btn:hover{background:rgba(255,255,255,0.2)}
        
        /* Stat cards - PLM style with icons */
        .stats{display:grid;grid-template-columns:repeat(8,1fr);gap:12px;margin-bottom:24px}
        .stat{background:#fff;border-radius:12px;padding:14px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 3px rgba(0,0,0,0.1);cursor:pointer;transition:all 0.2s;border-left:4px solid}
        .stat:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.1)}
        .stat-info .label{font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px}
        .stat-info .num{font-size:26px;font-weight:700}
        .stat-icon{font-size:24px;opacity:0.8}
        .stat.red{border-left-color:#ef4444}.stat.red .num{color:#ef4444}
        .stat.yellow{border-left-color:#eab308}.stat.yellow .num{color:#eab308}
        .stat.orange{border-left-color:#f97316}.stat.orange .num{color:#f97316}
        .stat.gray{border-left-color:#6b7280}.stat.gray .num{color:#6b7280}
        .stat.teal{border-left-color:#14b8a6}.stat.teal .num{color:#14b8a6}
        .stat.rose{border-left-color:#ec4899}.stat.rose .num{color:#ec4899}
        .stat.green{border-left-color:#22c55e}.stat.green .num{color:#22c55e}
        .stat.purple{border-left-color:#7c3aed}.stat.purple .num{color:#7c3aed}
        
        /* Tabs - Cleaner design */
        .tabs{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:24px}
        .tab-row{display:flex;border-bottom:1px solid #e5e7eb;padding:0 8px;flex-wrap:wrap}
        .tab{padding:14px 20px;cursor:pointer;border-bottom:2px solid transparent;font-weight:500;font-size:13px;color:#64748b;display:flex;align-items:center;gap:8px;transition:all 0.15s}
        .tab:hover{color:#3b82f6;background:#f8fafc}
        .tab.active{color:#3b82f6;border-bottom-color:#3b82f6}
        .tab .count{background:#f1f5f9;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;color:#64748b}
        .tab.active .count{background:#dbeafe;color:#3b82f6}
        .tab-divider{width:1px;background:#e5e7eb;margin:12px 8px}
        
        /* Filters */
        .filters{padding:14px 20px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;background:#f9fafb;border-top:1px solid #e5e7eb}
        .filters select{padding:8px 12px;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;min-width:130px;cursor:pointer;background:#fff;color:#334155}
        .filters select:hover{border-color:#3b82f6}
        .filters select:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
        .filters label{display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;color:#475569}
        .filters label input{width:16px;height:16px;accent-color:#3b82f6}
        .clear-filters-btn{padding:8px 14px;border:1px solid #e2e8f0;border-radius:8px;background:#fff;color:#64748b;font-size:13px;cursor:pointer;transition:all 0.15s;display:none}
        .clear-filters-btn:hover{background:#fee2e2;border-color:#fca5a5;color:#dc2626}
        .clear-filters-btn.visible{display:inline-flex;align-items:center;gap:6px}
        .active-filters{display:flex;flex-wrap:wrap;gap:8px;padding:12px 20px;background:#eff6ff;border-top:1px solid #bfdbfe;align-items:center}
        .active-filters:empty{display:none}
        .active-filters-label{font-size:12px;color:#3b82f6;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
        .filter-tag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:#fff;border:1px solid #bfdbfe;border-radius:6px;font-size:12px;color:#1e40af}
        .filter-tag .remove{cursor:pointer;color:#64748b;font-weight:bold}
        .filter-tag .remove:hover{color:#dc2626}
        
        /* Grid/Table */
        .grid{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow:hidden}
        .grid-table{width:100%;border-collapse:collapse}
        .grid-table thead{display:table-header-group}
        .grid-table thead tr{display:table-row;background:#f9fafb}
        .grid-table th{padding:14px 16px;font-size:12px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.5px;text-align:left;white-space:nowrap;border-bottom:1px solid #e5e7eb}
        .grid-table th:first-child{padding-left:24px}
        .grid-table th:last-child{padding-right:24px}
        .grid-table th.premium-col{text-align:right}
        .grid-table th.center{text-align:center}
        .grid-table td{padding:14px 16px;border-bottom:1px solid #e5e7eb;vertical-align:middle}
        .grid-table td:first-child{padding-left:24px}
        .grid-table td:last-child{padding-right:24px}
        .grid-table tbody tr{transition:all 0.15s ease}
        .grid-table tbody tr:nth-child(even){background:#f9fafb}
        .grid-table tbody tr:hover td{background:#f1f5f9}
        
        /* Policy cell */
        .policy-cell{display:flex;gap:14px;align-items:flex-start;min-width:0;text-align:left}
        .policy-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;background:#f1f5f9;color:#64748b}
        .policy-info{min-width:0;flex:1}
        .policy-info .type-badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:500;margin-bottom:6px}
        .policy-info .type-badge.renewal{background:#dbeafe;color:#2563eb}
        .policy-info .type-badge.new{background:#fef3c7;color:#d97706}
        .policy-info h3{font-size:14px;font-weight:500;margin-bottom:4px;line-height:1.4;color:#111827}
        .policy-info .meta{font-size:12px;color:#6b7280;margin-bottom:4px}
        .policy-info .carrier{font-size:12px;color:#374151;font-weight:500}
        .policy-info .notes{font-size:11px;color:#059669;background:#ecfdf5;padding:4px 10px;border-radius:4px;display:inline-block;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500;margin-top:4px}
        
        /* Date cells */
        .date-cell{font-size:13px;color:#374151;white-space:nowrap}
        .due-cell{text-align:center}
        .due-badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;white-space:nowrap}
        .due-badge.past{background:#fef2f2;color:#dc2626}
        .due-badge.today{background:#fefce8;color:#ca8a04}
        .due-badge.tomorrow{background:#fff7ed;color:#ea580c}
        .due-badge.week{background:#eff6ff;color:#2563eb}
        .due-badge.future{background:#f1f5f9;color:#64748b}
        .due-date{font-size:12px;color:#6b7280;margin-top:4px}
        
        /* Status badge */
        .status-cell{position:relative;text-align:center}
        .status-badge{display:inline-block;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:500;cursor:pointer;white-space:nowrap;transition:all 0.15s}
        .status-badge:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
        .status-dd{position:fixed;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,0.12);z-index:1000;min-width:180px;max-height:320px;overflow-y:auto;display:none}
        .status-dd.open{display:block}
        .status-opt{padding:10px 14px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:10px}
        .status-opt:hover{background:#f8fafc}
        .status-dot{width:8px;height:8px;border-radius:50%}
        
        /* Assignee */
        .assignee-cell{position:relative;text-align:center}
        .assignee-badge{display:inline-flex;align-items:center;gap:8px;padding:6px 12px 6px 6px;border-radius:50px;font-size:12px;cursor:pointer;font-weight:500;max-width:100%;transition:all 0.15s;background:#f8fafc;border:1px solid #e2e8f0;color:#374151}
        .assignee-badge:hover{background:#f1f5f9;border-color:#cbd5e1}
        .assignee-badge .init{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:#fff;flex-shrink:0}
        .assignee-badge .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .assignee-dd{position:fixed;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,0.12);z-index:1000;width:280px;display:none}
        .assignee-dd.open{display:block}
        .assignee-dd input{width:100%;padding:10px 14px;border:none;border-bottom:1px solid #e5e7eb;font-size:13px;outline:none;border-radius:8px 8px 0 0}
        .assignee-list{max-height:260px;overflow-y:auto}
        .assignee-opt{padding:10px 14px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:10px}
        .assignee-opt:hover{background:#f8fafc}
        .assignee-opt .avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;color:#fff}
        
        /* Premium */
        .premium-cell{text-align:right !important}
        .premium-main{font-size:14px;font-weight:600;color:#111827}
        .premium-exp{font-size:11px;color:#94a3b8;text-decoration:line-through}
        .premium-chg{font-size:11px;margin-top:2px;font-weight:500}
        .premium-chg.up{color:#ef4444}
        .premium-chg.down{color:#22c55e}
        
        /* Actions */
        .action-btn{background:#dbeafe;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:14px;transition:all 0.15s}
        .action-btn:hover{background:#bfdbfe}
        .ams-btn{background:#f3e8ff}
        .ams-btn:hover{background:#e9d5ff}
        
        /* Pagination */
        .pagination{padding:14px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:#fff;font-size:13px;color:#6b7280}
        .pagination-left{display:flex;align-items:center;gap:16px}
        .page-size-select{display:flex;align-items:center;gap:8px;font-size:13px;color:#6b7280}
        .page-size-select select{padding:6px 10px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px;cursor:pointer;background:#fff}
        .page-btn{padding:6px 12px;border:1px solid #e2e8f0;border-radius:6px;background:#fff;cursor:pointer;font-size:13px;transition:all 0.15s}
        .page-btn.active{background:#3b82f6;color:#fff;border-color:#3b82f6}
        .page-btn:hover:not(.active):not(:disabled){border-color:#3b82f6;color:#3b82f6}
        .page-btn:disabled{opacity:0.4;cursor:not-allowed}
        
        /* Panel */
        .panel-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);z-index:100;display:none}
        .panel-bg.open{display:block}
        .panel{position:fixed;top:0;right:-560px;width:560px;height:100%;background:#fff;z-index:101;transition:right 0.25s ease;display:flex;flex-direction:column;box-shadow:-4px 0 25px rgba(0,0,0,0.15)}
        .panel.open{right:0}
        .panel-header{padding:20px 24px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:#fff}
        .panel-header h2{font-size:18px;font-weight:600;color:#111827;margin:0}
        .panel-close{width:32px;height:32px;border:none;background:#f1f5f9;border-radius:6px;font-size:18px;cursor:pointer;color:#6b7280;transition:all 0.15s}
        .panel-close:hover{background:#e2e8f0}
        .panel-body{flex:1;overflow-y:auto;padding:24px}
        .panel-footer{padding:20px 24px;border-top:1px solid #e5e7eb;display:flex;gap:12px;justify-content:flex-end;background:#f9fafb}
        .section{margin-bottom:24px}
        .section h3{font-size:12px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:14px}
        .field{margin-bottom:14px}
        .field label{display:block;font-size:13px;color:#374151;margin-bottom:6px;font-weight:500}
        .field input,.field select,.field textarea{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;font-family:inherit}
        .field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
        .field textarea{min-height:80px;resize:vertical}
        .autocomplete{position:relative}
        .autocomplete-dd{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #e5e7eb;border-top:none;border-radius:0 0 8px 8px;box-shadow:0 10px 30px rgba(0,0,0,0.1);max-height:250px;overflow-y:auto;z-index:10;display:none}
        .autocomplete-dd.open{display:block}
        .autocomplete-opt{padding:10px 12px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:10px}
        .autocomplete-opt:hover{background:#f8fafc}
        .autocomplete-opt .avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;color:#fff}
        .btn{padding:10px 20px;border-radius:8px;font-size:14px;cursor:pointer;font-weight:500;transition:all 0.15s}
        .btn-cancel{background:#fff;border:1px solid #d1d5db;color:#374151}
        .btn-cancel:hover{background:#f9fafb}
        .btn-save{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;border:none}
        .btn-save:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,0.4)}
        
        /* Loading & Toast */
        .loading{text-align:center;padding:60px;color:#6b7280}
        .spinner{width:48px;height:48px;border:4px solid #e2e8f0;border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .toast{position:fixed;bottom:24px;right:24px;background:#1e293b;color:#fff;padding:14px 20px;border-radius:8px;display:none;z-index:200;font-weight:500;font-size:13px;box-shadow:0 10px 30px rgba(0,0,0,0.2)}
        .toast.show{display:block}
        .toast.ok{background:#22c55e}
        .toast.err{background:#ef4444}
        
        /* Footer */
        .footer{text-align:center;padding:24px;color:#6b7280;font-size:13px}
        
        @media(max-width:1200px){.stats{grid-template-columns:repeat(4,1fr)}}
        @media(max-width:900px){.stats{grid-template-columns:repeat(3,1fr)}.header{flex-direction:column;text-align:center}.header-right{flex-wrap:wrap;justify-content:center}}
        @media(max-width:600px){.stats{grid-template-columns:repeat(2,1fr)}}
    </style>
</head>
<body>
    <div id="login" class="login-screen"><div class="login-card"><h1>üìã Policy Management</h1><p>Sign in with your Microsoft 365 account</p><button class="login-btn" onclick="signIn()">Sign In with Microsoft</button></div></div>
    <div id="app" class="app">
        <header id="appHeader" class="header">
            <div class="header-left">
                <h1>üìã Policy Management</h1>
                <p>Track and manage policy renewals & billing</p>
            </div>
            <div class="header-right">
                <span class="header-welcome">Welcome, <span id="userName">User</span></span>
                <div class="search-box"><input type="text" id="search" placeholder="Search policies..." oninput="filter()"></div>
                <button class="new-btn" onclick="refreshData()" title="Refresh data">üîÑ</button>
                <button class="new-btn" onclick="newPolicy()">+ New Policy</button>
                <button class="signout-btn" onclick="signOut()">Sign Out</button>
            </div>
        </header>
        
        <div class="stats">
            <div class="stat red" onclick="filterStat('pastDue')"><div class="stat-info"><div class="label">Past Due</div><div class="num" id="sPastDue">0</div></div><div class="stat-icon">üö®</div></div>
            <div class="stat purple" onclick="filterStat('needsAction')"><div class="stat-info"><div class="label">Needs Action</div><div class="num" id="sNeedsAction">0</div></div><div class="stat-icon">üîî</div></div>
            <div class="stat yellow" onclick="filterStat('dueToday')"><div class="stat-info"><div class="label">Due Today</div><div class="num" id="sDueToday">0</div></div><div class="stat-icon">üìÖ</div></div>
            <div class="stat orange" onclick="filterStat('dueWeek')"><div class="stat-info"><div class="label">Due This Week</div><div class="num" id="sDueWeek">0</div></div><div class="stat-icon">‚ö†Ô∏è</div></div>
            <div class="stat gray" onclick="filterStat('progress')"><div class="stat-info"><div class="label">In Progress</div><div class="num" id="sProgress">0</div></div><div class="stat-icon">‚è≥</div></div>
            <div class="stat green" onclick="filterStat('unassign')"><div class="stat-info"><div class="label">Unassigned</div><div class="num" id="sUnassign">0</div></div><div class="stat-icon">üë§</div></div>
            <div class="stat teal" onclick="filterStat('billing')"><div class="stat-info"><div class="label">In Billing</div><div class="num" id="sBilling">0</div></div><div class="stat-icon">üí∞</div></div>
            <div class="stat rose" onclick="filterStat('billPast')"><div class="stat-info"><div class="label">Billing Past Due</div><div class="num" id="sBillPast">0</div></div><div class="stat-icon">‚ùå</div></div>
        </div>
        
        <main class="main-content">
            <div class="tabs">
                <div class="tab-row">
                    <div class="tab active" data-tab="myPolicy" onclick="switchTab('myPolicy')">üìã My Policies<span class="count" id="tMyPol">0</span></div>
                    <div class="tab" data-tab="myBilling" onclick="switchTab('myBilling')">üí∞ My Billing<span class="count" id="tMyBil">0</span></div>
                    <div class="tab-divider"></div>
                    <div class="tab" data-tab="allPolicy" onclick="switchTab('allPolicy')">üìã All Policies<span class="count" id="tAllPol">0</span></div>
                    <div class="tab" data-tab="allBilling" onclick="switchTab('allBilling')">üí∞ All Billing<span class="count" id="tAllBil">0</span></div>
                    <div class="tab" data-tab="archived" onclick="switchTab('archived')">üìÅ Archived<span class="count" id="tArch">0</span></div>
                </div>
                <div class="filters">
                    <select id="fStatus" onchange="filter()"><option value="">All Statuses</option></select>
                    <select id="fAssignee" onchange="filter()"><option value="">All Assignees</option></select>
                    <select id="fType" onchange="filter()"><option value="">All Types</option></select>
                    <select id="fTransType" onchange="filter()"><option value="">All Transactions</option><option value="Renewal">Renewal</option><option value="New Business">New Business</option></select>
                    <select id="fBizType" onchange="filter()"><option value="">All Business</option><option value="CL">CL - Commercial</option><option value="PL">PL - Personal</option></select>
                    <select id="fPolicyStatus" onchange="filter()"><option value="">All AMS360 Statuses</option></select>
                    <label><input type="checkbox" id="fUnassigned" onchange="filter()"> Unassigned Only</label>
                    <label><input type="checkbox" id="fShowAll" onchange="filter()"> Show All Dates</label>
                    <button class="clear-filters-btn" id="clearFiltersBtn" onclick="clearFilters()">‚úï Clear Filters</button>
                </div>
                <div class="active-filters" id="activeFilters"></div>
            </div>
            <div class="grid" id="gridContainer">
                <div class="pagination" id="paginationTop" style="display:none;border-bottom:1px solid #e5e7eb"><div class="pagination-left"><div id="pageInfoTop"></div><div class="page-size-select">Show <select id="pageSizeTop" onchange="changePageSize(this.value)"><option value="10">10</option><option value="50">50</option><option value="100">100</option></select> per page</div></div><div id="pageBtnsTop"></div></div>
                <table class="grid-table" id="gridTable">
                    <thead id="gridHeader"><tr><th>POLICY</th><th>AMS</th><th>DUE DATE</th><th>STATUS</th><th>ASSIGNED TO</th><th>EFF DATE</th><th class="premium-col">PREMIUM</th><th></th></tr></thead>
                    <tbody id="gridBody"><tr><td colspan="8" class="loading"><div class="spinner"></div>Loading policies...</td></tr></tbody>
                </table>
                <div class="pagination" id="pagination" style="display:none"><div class="pagination-left"><div id="pageInfo"></div><div class="page-size-select">Show <select id="pageSize" onchange="changePageSize(this.value)"><option value="10">10</option><option value="50">50</option><option value="100">100</option></select> per page</div></div><div id="pageBtns"></div></div>
            </div>
        </main>
        
        <footer class="footer">üîí Data stored in SharePoint | <span id="appVersion">v70</span></footer>
    </div>
    <div class="panel-bg" id="panelBg" onclick="closePanel()"></div>
    <div class="panel" id="panel"><div class="panel-header"><h2 id="panelTitle">Policy Details</h2><button class="panel-close" onclick="closePanel()">√ó</button></div><div class="panel-body" id="panelBody"></div><div class="panel-footer"><button class="btn btn-cancel" onclick="closePanel()">Cancel</button><button class="btn btn-save" onclick="save()">Save Changes</button></div></div>
    <div class="toast" id="toast"></div>
<script>
// App Version - increment this when deploying updates
const APP_VERSION = 70;

// Version check - runs on page load to detect updates
(function checkForUpdates(){
    const lastCheck = sessionStorage.getItem('pm_version_checked');
    const now = Date.now();
    // Only check once per session or every 60 seconds
    if(lastCheck && (now - parseInt(lastCheck)) < 60000) return;
    sessionStorage.setItem('pm_version_checked', now);
    
    fetch(location.pathname + '?_nocache=' + now, {cache: 'no-store'})
        .then(r => r.text())
        .then(html => {
            const match = html.match(/const APP_VERSION\s*=\s*(\d+)/);
            if(match){
                const serverVersion = parseInt(match[1]);
                if(serverVersion > APP_VERSION){
                    console.log('New version available:', serverVersion, '(current:', APP_VERSION + ')');
                    // Force cache-busted redirect
                    location.replace(location.pathname + '?_v=' + serverVersion + '&_t=' + now);
                }
            }
        })
        .catch(e => console.log('Version check failed:', e));
})();

const CONFIG={clientId:'d2dbeace-3b37-4da9-85db-0bb4ca328f68',tenantId:'8b20613e-54c4-43a3-af63-92cdbf260edb',siteId:'9159d942-f331-4ac9-bd64-d609d016f38a',listId:'eb615fe6-0253-45b6-bab1-d436c553e5df',siteHost:'gancfried.sharepoint.com'};
const STATUSES=['Not Started','In-Progress','Pending ‚Äì Quote','Pending ‚Äì Customer','Pending ‚Äì Underwriting','Quote-Received','Bound-Direct Bill','Bound','Bound-New carrier','Lost','Replaced'];
const BILL_STATUSES=['Not Started','Invoice Sent','Payment Received','Closed'];
const COLORS={'Not Started':'#6b7280','In-Progress':'#2563eb','Pending ‚Äì Quote':'#7c3aed','Pending ‚Äì Customer':'#d97706','Pending ‚Äì Underwriting':'#db2777','Quote-Received':'#059669','Bound-Direct Bill':'#d97706','Bound':'#16a34a','Bound-New carrier':'#0891b2','Lost':'#dc2626','Replaced':'#6b7280','Invoice Sent':'#d97706','Payment Received':'#16a34a','Closed':'#6b7280'};
const EXIT=['Bound','Bound-Direct Bill','Bound-New carrier','Lost','Replaced'],PROGRESS=['In-Progress','Pending ‚Äì Quote','Pending ‚Äì Customer','Pending ‚Äì Underwriting','Quote-Received'],ACOLORS=['#dc2626','#ea580c','#d97706','#16a34a','#0891b2','#2563eb','#7c3aed','#c026d3','#059669','#0d9488','#6366f1','#8b5cf6','#ec4899','#f43f5e','#84cc16','#06b6d4'];
const msalConfig={auth:{clientId:CONFIG.clientId,authority:`https://login.microsoftonline.com/${CONFIG.tenantId}`,redirectUri:location.origin},cache:{cacheLocation:'localStorage',storeAuthStateInCookie:true}};
let msal,user,token,currentUserId=null,policies=[],filtered=[],siteUsers=[],tab='myPolicy',selected=null,page=1,PAGE_SIZE=10,statFilter=null;
const F_ASSIGNED='AssignedTo0LookupId',F_NOTES='NextStep';

// HTML escape function to prevent template literal breaking
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/`/g,'&#96;')}

document.addEventListener('DOMContentLoaded',async()=>{msal=new window.msal.PublicClientApplication(msalConfig);await msal.initialize();const a=msal.getAllAccounts();if(a.length){user=a[0];await getToken();showApp()}STATUSES.forEach(s=>document.getElementById('fStatus').innerHTML+=`<option value="${s}">${s}</option>`);document.addEventListener('click',e=>{if(!e.target.closest('.status-cell')&&!e.target.closest('.status-dd'))document.querySelectorAll('.status-dd').forEach(d=>d.remove());if(!e.target.closest('.assignee-cell')&&!e.target.closest('.assignee-dd'))document.querySelectorAll('.assignee-dd').forEach(d=>d.remove());if(!e.target.closest('.autocomplete'))document.querySelectorAll('.autocomplete-dd').forEach(d=>d.classList.remove('open'))})});
async function signIn(){try{const r=await msal.loginPopup({scopes:['User.Read','User.ReadBasic.All','Sites.ReadWrite.All']});user=r.account;token=r.accessToken;showApp()}catch(e){console.error(e);toast('Login failed','err')}}
async function getToken(){try{const r=await msal.acquireTokenSilent({scopes:['User.Read','User.ReadBasic.All','Sites.ReadWrite.All'],account:user});token=r.accessToken}catch(e){const r=await msal.acquireTokenPopup({scopes:['User.Read','User.ReadBasic.All','Sites.ReadWrite.All']});token=r.accessToken}return token}
function signOut(){msal.logoutPopup()}
async function showApp(){document.getElementById('login').style.display='none';document.getElementById('app').style.display='block';document.getElementById('appHeader').classList.add('visible');const name=user.name||user.username||'User';document.getElementById('userName').textContent=name.split(' ')[0];document.getElementById('appVersion').textContent='v'+APP_VERSION;loadPageSizePreference();await loadSiteUsers();await loadPolicies();startAutoRefresh()}

function loadPageSizePreference(){
    const userKey=user.username||user.name||'default';
    const saved=localStorage.getItem('pm_pageSize_'+userKey);
    if(saved&&[10,50,100].includes(parseInt(saved))){
        PAGE_SIZE=parseInt(saved);
    }
    document.getElementById('pageSize').value=PAGE_SIZE;
    document.getElementById('pageSizeTop').value=PAGE_SIZE;
}

function changePageSize(size){
    PAGE_SIZE=parseInt(size);
    document.getElementById('pageSize').value=size;
    document.getElementById('pageSizeTop').value=size;
    const userKey=user.username||user.name||'default';
    localStorage.setItem('pm_pageSize_'+userKey,size);
    page=1;
    render();
    toast('Showing '+size+' items per page','ok');
}
async function graph(url,opts={},retry=true){
    if(!token)await getToken();
    const r=await fetch(`https://graph.microsoft.com/v1.0${url}`,{...opts,headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}});
    if(!r.ok){
        // If 401 Unauthorized, token likely expired - get new token and retry once
        if(r.status===401 && retry){
            console.log('Token expired, refreshing...');
            token=null;
            await getToken();
            return graph(url,opts,false);
        }
        const t=await r.text();
        console.error('Graph:',r.status,t);
        throw new Error(t);
    }
    return r.json();
}

async function loadSiteUsers(){try{const r=await graph(`/sites/${CONFIG.siteHost},${CONFIG.siteId}/lists/User%20Information%20List/items?$expand=fields&$top=500`);siteUsers=r.value.map(u=>({id:String(u.fields.id),name:u.fields.Title||'',email:u.fields.EMail||''})).filter(u=>u.name);const email=user.username?.toLowerCase();const me=siteUsers.find(u=>u.email?.toLowerCase()===email);if(me)currentUserId=me.id;console.log('Current user:',currentUserId)}catch(e){console.log('Site users error:',e.message)}}

async function loadPolicies(){document.getElementById('gridBody').innerHTML='<tr><td colspan="8" style="text-align:center;padding:40px"><div class="spinner"></div>Loading policies...</td></tr>';try{policies=[];let url=`/sites/${CONFIG.siteHost},${CONFIG.siteId}/lists/${CONFIG.listId}/items?$expand=fields&$top=999`;const types=new Set();while(url){const r=await graph(url);r.value.forEach(item=>{const f=item.fields;let assignedId=f[F_ASSIGNED]?String(f[F_ASSIGNED]):null,assignedName=null;if(assignedId){const u=siteUsers.find(su=>su.id===assignedId);if(u)assignedName=u.name}const pType=f.PolicyType||'';if(pType)types.add(pType);policies.push({id:item.id,Title:f.Title||'',PolicyNumber:f.PolicyNumber||'',PolicyType:pType,Carrier:f.Carrier||'',BizType:f.BusinessWithAgency||'',EffDate:f.EffectiveDate||'',ExpDate:f.ExpirationDate||'',ExpCost:f.ExpiringTotalCost,RenCost:f.RenewalTotalCost,DollarChg:f._x0024__x0020_Change,PctChg:f.PercentChange,Status:f.RenewalStatus||'Not Started',BillStatus:f.BillingStatus||'Not Started',Notes:f[F_NOTES]||'',IntNotes:f.InternalNotes||'',TransType:f.TransactionType||'Renewal',Archived:f.Archived||false,AssignedId:assignedId,AssignedName:assignedName,AMS360Link:f.AMS360CustomerLink?.Url||'',PolicyStatus:f.PolicyStatus||''})});url=r['@odata.nextLink']?r['@odata.nextLink'].replace('https://graph.microsoft.com/v1.0',''):null}const typeSelect=document.getElementById('fType');[...types].sort().forEach(t=>typeSelect.innerHTML+=`<option value="${t}">${t}</option>`);console.log('Loaded:',policies.length);buildAssigneeFilter();buildPolicyStatusFilter();filter();updateStats()}catch(e){console.error('Load:',e);document.getElementById('gridBody').innerHTML='<tr><td colspan="8" style="text-align:center;padding:40px;color:#dc2626">Error loading policies</td></tr>'}}

function buildAssigneeFilter(){const names=new Map();policies.forEach(p=>{if(p.AssignedId&&p.AssignedName)names.set(p.AssignedId,p.AssignedName)});const sel=document.getElementById('fAssignee');sel.innerHTML='<option value="">All Assignees</option>';[...names.entries()].sort((a,b)=>a[1].localeCompare(b[1])).forEach(([id,name])=>sel.innerHTML+=`<option value="${id}">${name}</option>`)}

function buildPolicyStatusFilter(){const statuses=new Set();policies.forEach(p=>{if(p.PolicyStatus)statuses.add(p.PolicyStatus)});const sel=document.getElementById('fPolicyStatus');const cur=sel.value;sel.innerHTML='<option value="">All AMS360 Statuses</option>';[...statuses].sort().forEach(s=>sel.innerHTML+=`<option value="${s}">${s}</option>`);sel.value=cur}

// Auto-refresh functionality
let lastRefresh=Date.now();
let refreshInterval=null;
let isRefreshing=false; // Guard against concurrent refreshes
const REFRESH_INTERVAL=3*60*1000; // 3 minutes
const VISIBILITY_THRESHOLD=60*1000; // 1 minute

async function refreshData(silent=false){
    // Prevent concurrent refreshes which cause duplicate data
    if(isRefreshing){console.log('Refresh already in progress, skipping');return}
    isRefreshing=true;
    if(!silent)toast('Refreshing...','');
    try{
        const oldPolicies=policies;
        policies=[];
        let url=`/sites/${CONFIG.siteHost},${CONFIG.siteId}/lists/${CONFIG.listId}/items?$expand=fields&$top=999`;
        while(url){
            const r=await graph(url);
            r.value.forEach(item=>{
                const f=item.fields;
                let assignedId=f[F_ASSIGNED]?String(f[F_ASSIGNED]):null,assignedName=null;
                if(assignedId){const u=siteUsers.find(su=>su.id===assignedId);if(u)assignedName=u.name}
                policies.push({id:item.id,Title:f.Title||'',PolicyNumber:f.PolicyNumber||'',PolicyType:f.PolicyType||'',Carrier:f.Carrier||'',BizType:f.BusinessWithAgency||'',EffDate:f.EffectiveDate||'',ExpDate:f.ExpirationDate||'',ExpCost:f.ExpiringTotalCost,RenCost:f.RenewalTotalCost,DollarChg:f._x0024__x0020_Change,PctChg:f.PercentChange,Status:f.RenewalStatus||'Not Started',BillStatus:f.BillingStatus||'Not Started',Notes:f[F_NOTES]||'',IntNotes:f.InternalNotes||'',TransType:f.TransactionType||'Renewal',Archived:f.Archived||false,AssignedId:assignedId,AssignedName:assignedName,AMS360Link:f.AMS360CustomerLink?.Url||'',PolicyStatus:f.PolicyStatus||''});
            });
            url=r['@odata.nextLink']?r['@odata.nextLink'].replace('https://graph.microsoft.com/v1.0',''):null;
        }
        lastRefresh=Date.now();
        buildAssigneeFilter();
        buildPolicyStatusFilter();
        filter();
        updateStats();
        if(!silent)toast('Data refreshed','ok');
    }catch(e){
        console.error('Refresh error:',e);
        if(!silent)toast('Refresh failed','err');
    }finally{
        isRefreshing=false;
    }
}

function startAutoRefresh(){
    if(refreshInterval)clearInterval(refreshInterval);
    refreshInterval=setInterval(()=>refreshData(true),REFRESH_INTERVAL);
    // Check for updates every 3 minutes (only start once)
    if(!window._versionCheckStarted){
        window._versionCheckStarted=true;
        setInterval(checkAppVersion, 180000);
    }
}

function checkAppVersion(){
    fetch(location.pathname + '?_nocache=' + Date.now(), {cache: 'no-store'})
        .then(r => r.text())
        .then(html => {
            const match = html.match(/const APP_VERSION\s*=\s*(\d+)/);
            if(match){
                const serverVersion = parseInt(match[1]);
                if(serverVersion > APP_VERSION){
                    if(confirm('A new version (v' + serverVersion + ') is available! Click OK to refresh and get the latest updates.')){
                        location.replace(location.pathname + '?_v=' + serverVersion + '&_t=' + Date.now());
                    }
                }
            }
        })
        .catch(e => console.log('Version check failed:', e));
}

// Refresh when tab becomes visible after being hidden
document.addEventListener('visibilitychange',async()=>{
    if(document.visibilityState==='visible'){
        const timeSinceRefresh=Date.now()-lastRefresh;
        // If idle for more than 5 minutes, force fresh token
        if(timeSinceRefresh > 5*60*1000){
            console.log('Long idle detected, forcing token refresh...');
            token=null;
            try{
                await getToken();
            }catch(e){
                console.error('Token refresh failed:', e);
                // If token refresh fails, might need to re-login
                toast('Session may have expired. Refreshing...','');
                setTimeout(()=>location.reload(),1500);
                return;
            }
        }
        if(timeSinceRefresh>VISIBILITY_THRESHOLD){
            refreshData(true);
            checkAppVersion();
        }
    }
});

// Parse date as local date (avoid timezone issues)
function parseLocalDate(dateStr){
    if(!dateStr)return null;
    const parts=dateStr.split('T')[0].split('-');
    return new Date(parseInt(parts[0]),parseInt(parts[1])-1,parseInt(parts[2]),0,0,0,0);
}

// Due date calculation
// Returns the actual date to DISPLAY (no adjustment)
// For Renewal: Expiration Date, For New Business: Effective Date
function getDue(p){
    if(p.TransType==='New Business'){
        return parseLocalDate(p.EffDate);
    }else{
        return parseLocalDate(p.ExpDate);
    }
}

// Badge calculation - for policy view, work is due 1 day BEFORE expiration
// So if ExpDate is Jan 30, badge should say "DUE TODAY" on Jan 29
function getDueBadge(p, isBilling=false){
    if(p.Archived)return null;
    const displayDate=getDue(p);if(!displayDate)return null;
    const today=new Date();today.setHours(0,0,0,0);
    
    // For badge: policy view subtracts 1 day (work due before expiration)
    // Billing view uses actual date
    let badgeDate=new Date(displayDate);
    if(!isBilling && p.TransType!=='New Business'){
        badgeDate.setDate(badgeDate.getDate()-1);
    }
    
    const diff=Math.floor((badgeDate-today)/86400000);
    if(diff<0)return{text:'PAST DUE',cls:'past'};
    if(diff===0)return{text:'DUE TODAY',cls:'today'};
    if(diff===1)return{text:'DUE TOMORROW',cls:'tomorrow'};
    if(diff<=7)return{text:`DUE IN ${diff} DAYS`,cls:'week'};
    if(diff<=60)return{text:`DUE IN ${diff} DAYS`,cls:'future'};
    return null;
}

function fmtShort(d){return d?d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):''}
function cur(v){return v!=null?'$'+Number(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):''}
function init(n){if(!n)return'?';const p=n.split(' ');return p.length>1?(p[0][0]+p[p.length-1][0]).toUpperCase():n.substring(0,2).toUpperCase()}
// Hash-based color assignment using first name for better distribution
function hashCode(str){let h=0;for(let i=0;i<str.length;i++)h=((h<<5)-h)+str.charCodeAt(i);return Math.abs(h)}
function acolor(id,name){
    if(name&&name!=='Unassigned'){
        // Extract first name (before pipe or space) for more distinct hashing
        const firstName=name.split(/[|\s]/)[0].trim();
        return ACOLORS[hashCode(firstName)%ACOLORS.length];
    }
    return ACOLORS[Math.abs(Number(id)||0)%ACOLORS.length];
}

function filter(preservePage=false){
    const search=document.getElementById('search').value.toLowerCase();
    const statusF=document.getElementById('fStatus').value;
    const assigneeF=document.getElementById('fAssignee').value;
    const typeF=document.getElementById('fType').value;
    const transTypeF=document.getElementById('fTransType').value;
    const bizTypeF=document.getElementById('fBizType').value;
    const policyStatusF=document.getElementById('fPolicyStatus').value;
    const unassignedF=document.getElementById('fUnassigned').checked;
    const showAll=document.getElementById('fShowAll').checked;
    const isMyPolicy=tab==='myPolicy';
    const isMyBilling=tab==='myBilling';
    const isAllBilling=tab==='allBilling';
    const isArchived=tab==='archived';
    const isBilling=isMyBilling||isAllBilling;
    const isMy=isMyPolicy||isMyBilling;
    
    const today=new Date();today.setHours(0,0,0,0);
    const past30=new Date(today);past30.setDate(past30.getDate()-30);
    const future90=new Date(today);future90.setDate(future90.getDate()+90);
    const week=new Date(today);week.setDate(week.getDate()+7);
    
    filtered=policies.filter(p=>{
        // For archived tab, only show archived items but still apply search/filters
        if(isArchived){
            if(!p.Archived)return false;
            // Apply search to archived items
            if(search){const txt=[p.Title,p.PolicyNumber,p.Carrier,p.Notes,p.AssignedName].join(' ').toLowerCase();if(!txt.includes(search))return false}
            if(statusF&&p.Status!==statusF)return false;
            if(assigneeF&&p.AssignedId!==assigneeF)return false;
            if(typeF&&p.PolicyType!==typeF)return false;
            if(bizTypeF&&p.BizType!==bizTypeF)return false;
            if(policyStatusF&&p.PolicyStatus!==policyStatusF)return false;
            if(unassignedF&&p.AssignedId)return false;
            return true;
        }
        if(p.Archived)return false;
        if(isMy&&p.AssignedId!==currentUserId)return false;
        if(!showAll&&p.ExpDate){
            const exp=parseLocalDate(p.ExpDate);
            if(exp&&(exp<past30||exp>future90))return false;
        }
        if(isBilling){
            if(!['Bound','Bound-New carrier'].includes(p.Status))return false;
            if(['Payment Received','Closed'].includes(p.BillStatus))return false;
        }else if(!isArchived){
            if(EXIT.includes(p.Status))return false;
        }
        
        // Stat card filters - STRICT matching
        if(statFilter){
            const isPol=!EXIT.includes(p.Status);
            const isBil=['Bound','Bound-New carrier'].includes(p.Status)&&!['Payment Received','Closed'].includes(p.BillStatus);
            
            if(statFilter==='pastDue'){
                // Policy badge date = exp - 1 for Renewal
                let badgeDate=getDue(p);
                if(badgeDate && p.TransType!=='New Business'){
                    badgeDate=new Date(badgeDate);
                    badgeDate.setDate(badgeDate.getDate()-1);
                }
                if(!isPol||!badgeDate||badgeDate>=today)return false;
            }
            if(statFilter==='dueWeek'){
                let badgeDate=getDue(p);
                if(badgeDate && p.TransType!=='New Business'){
                    badgeDate=new Date(badgeDate);
                    badgeDate.setDate(badgeDate.getDate()-1);
                }
                if(!isPol||!badgeDate||badgeDate<today||badgeDate>=week)return false;
            }
            if(statFilter==='dueToday'){
                const tomorrow=new Date(today);tomorrow.setDate(tomorrow.getDate()+1);
                let badgeDate=getDue(p);
                if(badgeDate && p.TransType!=='New Business'){
                    badgeDate=new Date(badgeDate);
                    badgeDate.setDate(badgeDate.getDate()-1);
                }
                if(!isPol||!badgeDate||badgeDate<today||badgeDate>=tomorrow)return false;
            }
            if(statFilter==='progress'){
                if(!isPol||!PROGRESS.includes(p.Status))return false;
            }
            if(statFilter==='billing'){
                if(!isBil)return false;
            }
            if(statFilter==='billPast'){
                // Billing uses actual date (no -1)
                const bilDate=getDue(p);
                if(!isBil||!bilDate||bilDate>=today)return false;
            }
            if(statFilter==='unassign'){
                const exp=parseLocalDate(p.ExpDate);
                if(!(!p.AssignedId&&exp&&exp>=today&&exp<=future90))return false;
            }
            if(statFilter==='needsAction'){
                let badgeDate=getDue(p);
                if(badgeDate && p.TransType!=='New Business'){
                    badgeDate=new Date(badgeDate);
                    badgeDate.setDate(badgeDate.getDate()-1);
                }
                if(!isPol||p.Status!=='Not Started'||!badgeDate||badgeDate>=week)return false;
            }
        }
        
        if(search){const txt=[p.Title,p.PolicyNumber,p.Carrier,p.Notes,p.AssignedName].join(' ').toLowerCase();if(!txt.includes(search))return false}
        if(statusF&&p.Status!==statusF)return false;
        if(assigneeF&&p.AssignedId!==assigneeF)return false;
        if(typeF&&p.PolicyType!==typeF)return false;
        if(transTypeF&&p.TransType!==transTypeF)return false;
        if(bizTypeF&&p.BizType!==bizTypeF)return false;
        if(policyStatusF&&p.PolicyStatus!==policyStatusF)return false;
        if(unassignedF&&p.AssignedId)return false;
        return true;
    });
    filtered.sort((a,b)=>{const dA=getDue(a),dB=getDue(b);if(!dA)return 1;if(!dB)return -1;return dA-dB});
    if(!preservePage){page=1;}else{const maxPage=Math.max(1,Math.ceil(filtered.length/PAGE_SIZE));if(page>maxPage)page=maxPage;}
    render();updateTabCounts();updateActiveFilters();
}

function clearFilters(){
    document.getElementById('search').value='';
    document.getElementById('fStatus').value='';
    document.getElementById('fAssignee').value='';
    document.getElementById('fType').value='';
    document.getElementById('fTransType').value='';
    document.getElementById('fBizType').value='';
    document.getElementById('fPolicyStatus').value='';
    document.getElementById('fUnassigned').checked=false;
    document.getElementById('fShowAll').checked=false;
    statFilter=null;
    filter();
}

function removeFilter(filterType){
    if(filterType==='search')document.getElementById('search').value='';
    else if(filterType==='status')document.getElementById('fStatus').value='';
    else if(filterType==='assignee')document.getElementById('fAssignee').value='';
    else if(filterType==='type')document.getElementById('fType').value='';
    else if(filterType==='transType')document.getElementById('fTransType').value='';
    else if(filterType==='bizType')document.getElementById('fBizType').value='';
    else if(filterType==='policyStatus')document.getElementById('fPolicyStatus').value='';
    else if(filterType==='unassigned')document.getElementById('fUnassigned').checked=false;
    else if(filterType==='showAll')document.getElementById('fShowAll').checked=false;
    else if(filterType==='stat')statFilter=null;
    filter();
}

function updateActiveFilters(){
    const container=document.getElementById('activeFilters');
    const clearBtn=document.getElementById('clearFiltersBtn');
    const tags=[];
    
    const search=document.getElementById('search').value;
    const statusF=document.getElementById('fStatus').value;
    const assigneeF=document.getElementById('fAssignee').value;
    const typeF=document.getElementById('fType').value;
    const transTypeF=document.getElementById('fTransType').value;
    const bizTypeF=document.getElementById('fBizType').value;
    const policyStatusF=document.getElementById('fPolicyStatus').value;
    const unassignedF=document.getElementById('fUnassigned').checked;
    const showAllF=document.getElementById('fShowAll').checked;
    
    if(search)tags.push({type:'search',label:`Search: "${search}"`});
    if(statFilter){
        const statLabels={'pastDue':'Past Due','dueToday':'Due Today','dueWeek':'Due This Week','needsAction':'Needs Action','progress':'In Progress','unassign':'Unassigned','billing':'In Billing','billPast':'Billing Past Due'};
        tags.push({type:'stat',label:`üìä ${statLabels[statFilter]||statFilter}`});
    }
    if(statusF)tags.push({type:'status',label:`Status: ${statusF}`});
    if(assigneeF){
        const assigneeName=document.getElementById('fAssignee').options[document.getElementById('fAssignee').selectedIndex].text;
        tags.push({type:'assignee',label:`Assignee: ${assigneeName}`});
    }
    if(typeF)tags.push({type:'type',label:`Type: ${typeF}`});
    if(transTypeF)tags.push({type:'transType',label:`Transaction: ${transTypeF}`});
    if(bizTypeF)tags.push({type:'bizType',label:`Business: ${bizTypeF==='CL'?'Commercial':'Personal'}`});
    if(policyStatusF)tags.push({type:'policyStatus',label:`AMS360 Status: ${policyStatusF}`});
    if(unassignedF)tags.push({type:'unassigned',label:'Unassigned Only'});
    if(showAllF)tags.push({type:'showAll',label:'All Dates'});
    
    if(tags.length>0){
        container.innerHTML='<span class="active-filters-label">Active Filters:</span>'+tags.map(t=>
            `<span class="filter-tag">${esc(t.label)}<span class="remove" onclick="removeFilter('${t.type}')">√ó</span></span>`
        ).join('');
        clearBtn.classList.add('visible');
    }else{
        container.innerHTML='';
        clearBtn.classList.remove('visible');
    }
}

function render(){
    const body=document.getElementById('gridBody');
    const gridTable=document.getElementById('gridTable');
    const total=filtered.length;
    const pages=Math.ceil(total/PAGE_SIZE);
    const start=(page-1)*PAGE_SIZE;
    const items=filtered.slice(start,start+PAGE_SIZE);
    const isBillingTab=tab==='myBilling'||tab==='allBilling';
    
    // Update header with table row
    const header=document.getElementById('gridHeader');
    if(isBillingTab){
        header.innerHTML='<tr><th>POLICY</th><th>AMS</th><th>DUE DATE</th><th>POLICY STATUS</th><th>BILLING STATUS</th><th>ASSIGNED TO</th><th>EFF DATE</th><th class="premium-col">PREMIUM</th><th></th></tr>';
    }else{
        header.innerHTML='<tr><th>POLICY</th><th>AMS</th><th>DUE DATE</th><th>STATUS</th><th>ASSIGNED TO</th><th>EFF DATE</th><th class="premium-col">PREMIUM</th><th></th></tr>';
    }
    
    if(!items.length){body.innerHTML='<tr><td colspan="'+(isBillingTab?9:8)+'" style="text-align:center;padding:40px;color:#6b7280">No policies found</td></tr>';document.getElementById('pagination').style.display='none';document.getElementById('paginationTop').style.display='none';return}
    
    body.innerHTML=items.map((p,idx)=>{
        const badge=getDueBadge(p, isBillingTab);
        const due=getDue(p);
        const effDate=parseLocalDate(p.EffDate);
        const color=COLORS[p.Status]||'#666';
        const billColor=COLORS[p.BillStatus]||'#666';
        const aName=p.AssignedName||'Unassigned';
        const ac=p.AssignedId?acolor(p.AssignedId,p.AssignedName):'#9ca3af';
        const icon=p.TransType==='New Business'?'‚ú®':'üîÑ';
        
        // Use server-calculated values if available, otherwise compute for display
        let displayDollarChg=p.DollarChg;
        let displayPctChg=p.PctChg;
        if(displayDollarChg==null&&displayPctChg==null&&p.ExpCost!=null&&p.RenCost!=null){
            const diff=p.RenCost-p.ExpCost;
            displayDollarChg='$'+Math.abs(diff).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
            if(diff<0)displayDollarChg='($'+Math.abs(diff).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})+')';
            else if(diff>0)displayDollarChg='$'+diff.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
            else displayDollarChg='$0.00';
            displayPctChg=p.ExpCost!==0?((diff/p.ExpCost)*100):0;
        }
        const hasChange=displayDollarChg||displayPctChg!=null;
        
        const isDecrease = p.ExpCost!=null && p.RenCost!=null && p.RenCost < p.ExpCost;
        let premiumHtml;
        if(hasChange&&p.RenCost!=null){
            premiumHtml=`${p.ExpCost!=null?`<div class="premium-exp">${cur(p.ExpCost)}</div>`:''}
                <div class="premium-main">${cur(p.RenCost)}</div>
                ${displayDollarChg?`<div class="premium-chg ${isDecrease?'down':'up'}">${displayDollarChg}</div>`:''}
                ${displayPctChg!=null?`<div class="premium-chg ${displayPctChg<0?'down':'up'}">(${displayPctChg>0?'+':''}${Math.round(displayPctChg)}%)</div>`:''}`;
        }else{
            const showAmt=p.ExpCost!=null?p.ExpCost:p.RenCost;
            premiumHtml=`<div class="premium-main">${cur(showAmt)}</div>`;
        }
        
        const transColor = p.TransType==='New Business'?'#d97706':'#2563eb';
        const transLabel = p.TransType==='New Business'?'NEW BUSINESS':'RENEWAL';
        const badgeClass = p.TransType==='New Business'?'new':'renewal';
        
        const policyCell=`<td class="policy-cell">
            <div class="policy-icon" style="background:${color}15;color:${color}">${icon}</div>
            <div class="policy-info">
                <span class="type-badge ${badgeClass}">${transLabel}</span>
                <h3>${esc(p.Title)}</h3>
                <div class="meta">${esc(p.PolicyNumber)}${p.PolicyType?' ‚Ä¢ '+esc(p.PolicyType):''}${p.BizType?' ‚Ä¢ '+p.BizType:''}${p.PolicyStatus?' ‚Ä¢ '+esc(p.PolicyStatus):''}</div>
                ${p.Carrier?`<div class="carrier">üè¢ ${esc(p.Carrier)}</div>`:''}
                ${p.Notes?`<div class="notes">üìù ${esc(p.Notes.length>30?p.Notes.substring(0,30)+'...':p.Notes)}</div>`:''}
            </div>
        </td>`;
        
        const amsCell=`<td class="ams-cell">${p.AMS360Link?`<a href="${esc(p.AMS360Link)}" target="_blank" title="Open in AMS360" class="action-btn ams-btn" style="display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;text-decoration:none">üîó</a>`:''}</td>`;
        
        const dueCell=`<td class="due-cell">
            ${badge?`<div class="due-badge ${badge.cls}">${badge.text}</div>`:''}
            <div class="due-date">${due?fmtShort(due):''}</div>
        </td>`;
        
        const statusCell=`<td class="status-cell">
            <div class="status-badge" style="background:${color}15;color:${color}" onclick="toggleStatus('${p.id}',false,this)">${p.Status}</div>
        </td>`;
        
        const billStatusCell=`<td class="status-cell">
            <div class="status-badge" style="background:${billColor}15;color:${billColor}" onclick="toggleStatus('${p.id}',true,this)">${p.BillStatus}</div>
        </td>`;
        
        const assigneeCell=`<td class="assignee-cell">
            <div class="assignee-badge" style="background:${ac}15;color:${ac}" onclick="toggleAssignee('${p.id}',this)">
                <div class="init" style="background:${ac}">${init(aName)}</div>
                <span class="name">${esc(aName)}</span>
            </div>
        </td>`;
        
        const effCell=`<td class="date-cell">${effDate?fmtShort(effDate):'-'}</td>`;
        const premiumCell=`<td class="premium-cell">${premiumHtml}</td>`;
        const btnCell=`<td><button class="action-btn" onclick="openPanel('${p.id}')" title="View Details">üìã</button></td>`;
        
        if(isBillingTab){
            return `<tr>${policyCell}${amsCell}${dueCell}${statusCell}${billStatusCell}${assigneeCell}${effCell}${premiumCell}${btnCell}</tr>`;
        }else{
            return `<tr>${policyCell}${amsCell}${dueCell}${statusCell}${assigneeCell}${effCell}${premiumCell}${btnCell}</tr>`;
        }
    }).join('');
    
    const pag=document.getElementById('pagination');
    const pagTop=document.getElementById('paginationTop');
    // Sync page size selects
    document.getElementById('pageSize').value=PAGE_SIZE;
    document.getElementById('pageSizeTop').value=PAGE_SIZE;
    if(total>0){
        const pageInfoText=`Showing ${start+1}-${Math.min(start+PAGE_SIZE,total)} of ${total}`;
        let btns='';
        if(pages>1){
            btns=`<button class="page-btn" onclick="goPage(${page-1})" ${page===1?'disabled':''}>‚Üê Prev</button>`;
            for(let i=Math.max(1,page-2);i<=Math.min(pages,page+2);i++)btns+=`<button class="page-btn ${i===page?'active':''}" onclick="goPage(${i})">${i}</button>`;
            btns+=`<button class="page-btn" onclick="goPage(${page+1})" ${page===pages?'disabled':''}>Next ‚Üí</button>`;
        }
        
        pag.style.display='flex';
        document.getElementById('pageInfo').textContent=pageInfoText;
        document.getElementById('pageBtns').innerHTML=btns;
        
        pagTop.style.display='flex';
        document.getElementById('pageInfoTop').textContent=pageInfoText;
        document.getElementById('pageBtnsTop').innerHTML=btns;
    }else{
        pag.style.display='none';
        pagTop.style.display='none';
    }
}

function goPage(p){if(p<1||p>Math.ceil(filtered.length/PAGE_SIZE))return;page=p;render();window.scrollTo(0,0)}

function toggleStatus(id,isBilling,el){
    document.querySelectorAll('.status-dd').forEach(d=>d.remove());
    const rect=el.getBoundingClientRect();
    const dd=document.createElement('div');
    dd.className='status-dd open';
    const spaceBelow=window.innerHeight-rect.bottom;
    const ddHeight=isBilling?180:400;
    if(spaceBelow<ddHeight){dd.style.bottom=(window.innerHeight-rect.top+6)+'px';}
    else{dd.style.top=(rect.bottom+6)+'px';}
    dd.style.left=rect.left+'px';
    const statuses=isBilling?BILL_STATUSES:STATUSES;
    dd.innerHTML=statuses.map(s=>`<div class="status-opt" onclick="event.stopPropagation();setStatus('${id}','${s}',${isBilling})"><div class="status-dot" style="background:${COLORS[s]||'#6b7280'}"></div>${s}</div>`).join('');
    document.body.appendChild(dd);
}

async function setStatus(id,status,isBilling){
    document.querySelectorAll('.status-dd').forEach(d=>d.remove());
    try{
        const field=isBilling?{BillingStatus:status}:{RenewalStatus:status};
        
        // Auto-archive logic
        // Renewal Status: Bound-Direct Bill, Lost ‚Üí auto-archive
        // Billing Status: Payment Received, Closed ‚Üí auto-archive
        const autoArchiveRenewal=['Bound-Direct Bill','Lost'];
        const autoArchiveBilling=['Payment Received','Closed'];
        let shouldArchive=false;
        if(!isBilling && autoArchiveRenewal.includes(status)){
            shouldArchive=true;
        }else if(isBilling && autoArchiveBilling.includes(status)){
            shouldArchive=true;
        }
        if(shouldArchive){
            field.Archived=true;
        }
        
        await graph(`/sites/${CONFIG.siteHost},${CONFIG.siteId}/lists/${CONFIG.listId}/items/${id}/fields`,{method:'PATCH',body:JSON.stringify(field)});
        const p=policies.find(x=>x.id===id);
        if(p){
            if(isBilling)p.BillStatus=status;else p.Status=status;
            if(shouldArchive)p.Archived=true;
        }
        toast(shouldArchive?'Status updated & Archived':'Status updated','ok');
        filter(true);updateStats();
    }catch(e){toast('Update failed','err')}
}

function toggleAssignee(id,el){
    document.querySelectorAll('.assignee-dd').forEach(d=>d.remove());
    const rect=el.getBoundingClientRect();
    const dd=document.createElement('div');
    dd.className='assignee-dd open';
    const spaceBelow=window.innerHeight-rect.bottom;
    if(spaceBelow<320){dd.style.bottom=(window.innerHeight-rect.top+6)+'px';}
    else{dd.style.top=(rect.bottom+6)+'px';}
    dd.style.left=Math.min(rect.left,window.innerWidth-320)+'px';
    dd.innerHTML=`<input type="text" placeholder="Search users..." oninput="searchGridUsersDD(this,'${id}')" onclick="event.stopPropagation()"><div class="assignee-list" id="al-dd-${id}"></div>`;
    document.body.appendChild(dd);
    dd.querySelector('input').focus();
    renderGridUserListDD(id,siteUsers.slice(0,12));
}

let gridSearchTimeout=null;
function searchGridUsersDD(input,policyId){
    const q=input.value.trim().toLowerCase();
    if(q.length<2){renderGridUserListDD(policyId,siteUsers.slice(0,12));return}
    const siteMatches=siteUsers.filter(u=>u.name.toLowerCase().includes(q));
    renderGridUserListDD(policyId,siteMatches.slice(0,12));
    clearTimeout(gridSearchTimeout);
    gridSearchTimeout=setTimeout(async()=>{
        try{
            const r=await graph(`/users?$filter=startswith(displayName,'${encodeURIComponent(q)}')&$select=id,displayName,mail&$top=10`);
            const azUsers=r.value.map(u=>({id:u.id,name:u.displayName,email:u.mail,isAzure:true}));
            const combined=[...siteMatches.map(u=>({...u,isAzure:false}))];
            azUsers.forEach(au=>{if(!combined.find(su=>su.name.toLowerCase()===au.name.toLowerCase()))combined.push(au)});
            renderGridUserListDD(policyId,combined.slice(0,12));
        }catch(e){console.error(e)}
    },300);
}

function renderGridUserListDD(policyId,users){
    const list=document.getElementById(`al-dd-${policyId}`);
    if(!list)return;
    list.innerHTML=`<div class="assignee-opt" onclick="setGridAssigneeDD('${policyId}','','',true)"><div class="avatar" style="background:#9ca3af">?</div>Unassigned</div>`+users.map(u=>{
        const isAzure=u.isAzure||!/^\d+$/.test(u.id);
        return `<div class="assignee-opt" onclick="setGridAssigneeDD('${policyId}','${u.id}','${u.name.replace(/'/g,"\\'")}',${!isAzure})"><div class="avatar" style="background:${acolor(u.id,u.name)}">${init(u.name)}</div><div style="flex:1;min-width:0"><div style="font-weight:500">${u.name}</div>${u.email?`<div style="font-size:11px;color:#9ca3af;overflow:hidden;text-overflow:ellipsis">${u.email}</div>`:''}${isAzure?`<div style="font-size:10px;color:#f59e0b">‚ö† Not in SharePoint</div>`:''}</div></div>`;
    }).join('');
}

async function setGridAssigneeDD(policyId,userId,userName,isSiteUser){
    document.querySelectorAll('.assignee-dd').forEach(d=>d.remove());
    if(userId&&!isSiteUser){toast('Add to SharePoint first','err');return}
    try{
        const fields={};fields[F_ASSIGNED]=userId?parseInt(userId):null;
        await graph(`/sites/${CONFIG.siteHost},${CONFIG.siteId}/lists/${CONFIG.listId}/items/${policyId}/fields`,{method:'PATCH',body:JSON.stringify(fields)});
        const p=policies.find(x=>x.id===policyId);
        if(p){p.AssignedId=userId||null;p.AssignedName=userName||null}
        toast('Assignee updated','ok');
        buildAssigneeFilter();buildPolicyStatusFilter();filter(true);updateStats();
    }catch(e){console.error(e);toast('Update failed','err')}
}

function updateStats(){
    const today=new Date();today.setHours(0,0,0,0);
    const tomorrow=new Date(today);tomorrow.setDate(tomorrow.getDate()+1);
    const week=new Date(today);week.setDate(week.getDate()+7);
    const f90=new Date(today);f90.setDate(f90.getDate()+90);
    let pd=0,dt=0,dw=0,ip=0,bl=0,bp=0,ua=0,na=0;
    policies.forEach(p=>{
        if(p.Archived)return;
        const exp=parseLocalDate(p.ExpDate);
        const isPol=!EXIT.includes(p.Status);
        const isBil=['Bound','Bound-New carrier'].includes(p.Status)&&!['Payment Received','Closed'].includes(p.BillStatus);
        
        // For stats: policy badge date = exp - 1 for Renewal
        if(isPol){
            let polBadgeDate=getDue(p);
            if(polBadgeDate && p.TransType!=='New Business'){
                polBadgeDate=new Date(polBadgeDate);
                polBadgeDate.setDate(polBadgeDate.getDate()-1);
            }
            if(polBadgeDate&&polBadgeDate<today)pd++;
            if(polBadgeDate&&polBadgeDate>=today&&polBadgeDate<tomorrow)dt++;
            if(polBadgeDate&&polBadgeDate>=today&&polBadgeDate<week)dw++;
            // Needs Action: past due or due this week AND status is Not Started
            if(p.Status==='Not Started'&&polBadgeDate&&polBadgeDate<week)na++;
        }
        // In progress: ONLY in PROGRESS statuses
        if(isPol&&PROGRESS.includes(p.Status))ip++;
        // Billing: uses actual exp date (no -1)
        if(isBil){
            bl++;
            const bilDate=getDue(p);
            if(bilDate&&bilDate<today)bp++;
        }
        // Unassigned
        if(!p.AssignedId&&exp&&exp>=today&&exp<=f90)ua++;
    });
    document.getElementById('sPastDue').textContent=pd;
    document.getElementById('sDueToday').textContent=dt;
    document.getElementById('sDueWeek').textContent=dw;
    document.getElementById('sProgress').textContent=ip;
    document.getElementById('sBilling').textContent=bl;
    document.getElementById('sBillPast').textContent=bp;
    document.getElementById('sUnassign').textContent=ua;
    document.getElementById('sNeedsAction').textContent=na;
}

function updateTabCounts(){
    const today=new Date();today.setHours(0,0,0,0);
    const past30=new Date(today);past30.setDate(past30.getDate()-30);
    const f90=new Date(today);f90.setDate(f90.getDate()+90);
    const showAll=document.getElementById('fShowAll').checked;
    let mp=0,mb=0,ap=0,ab=0,ar=0;
    policies.forEach(p=>{
        if(p.Archived){ar++;return}
        if(!showAll&&p.ExpDate){const exp=parseLocalDate(p.ExpDate);if(exp&&(exp<past30||exp>f90))return}
        const isPol=!EXIT.includes(p.Status),isBil=['Bound','Bound-New carrier'].includes(p.Status)&&!['Payment Received','Closed'].includes(p.BillStatus);
        if(isPol){ap++;if(p.AssignedId===currentUserId)mp++}
        if(isBil){ab++;if(p.AssignedId===currentUserId)mb++}
    });
    document.getElementById('tMyPol').textContent=mp;
    document.getElementById('tMyBil').textContent=mb;
    document.getElementById('tAllPol').textContent=ap;
    document.getElementById('tAllBil').textContent=ab;
    document.getElementById('tArch').textContent=ar;
}

function switchTab(t,preserveStatFilter){tab=t;if(!preserveStatFilter)statFilter=null;document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active',x.dataset.tab===t));filter()}

function filterStat(stat){
    statFilter=stat;
    document.getElementById('fStatus').value='';
    document.getElementById('fAssignee').value='';
    document.getElementById('fType').value='';
    document.getElementById('fBizType').value='';
    document.getElementById('fPolicyStatus').value='';
    document.getElementById('fUnassigned').checked=false;
    if(stat==='billing'||stat==='billPast')switchTab('allBilling',true);
    else switchTab('allPolicy',true);
}

function newPolicy(){
    selected=null;
    document.getElementById('panelTitle').textContent='New Policy';
    document.getElementById('panelBody').innerHTML=`
        <div class="section"><h3>Policy Information</h3>
            <div class="field"><label>Title</label><input id="pTitle" placeholder="Customer Name | Policy Number | Type"></div>
            <div class="field"><label>Policy Number</label><input id="pNum" placeholder="Policy number"></div>
            <div class="field"><label>Carrier / Company</label><input id="pCarrier" placeholder="Carrier name"></div>
            <div class="field"><label>Policy Type</label><input id="pPolicyType" placeholder="e.g. Commercial Property"></div>
            <div class="field"><label>Business with Agency</label><select id="pBizType"><option value="">Select...</option><option value="CL">CL - Commercial</option><option value="PL">PL - Personal</option></select></div>
            <div class="field"><label>Transaction Type</label><select id="pTransType"><option value="Renewal">Renewal</option><option value="New Business">New Business</option></select></div>
        </div>
        <div class="section"><h3>Dates</h3>
            <div class="field"><label>Effective Date</label><input type="date" id="pEff"></div>
            <div class="field"><label>Expiration Date</label><input type="date" id="pExp"></div>
        </div>
        <div class="section"><h3>Policy Status</h3>
            <div class="field"><label>Renewal Status</label><select id="pStatus">${STATUSES.map(s=>`<option value="${s}">${s}</option>`).join('')}</select></div>
            <div class="field"><label>Billing Status</label><select id="pBillStatus">${BILL_STATUSES.map(s=>`<option value="${s}">${s}</option>`).join('')}</select></div>
            <div class="field"><label>Assigned To</label>
                <div class="autocomplete">
                    <input type="text" id="pAssignName" placeholder="Search users..." oninput="searchPanelUsers(this.value)" onfocus="searchPanelUsers(this.value)">
                    <input type="hidden" id="pAssignId">
                    <input type="hidden" id="pAssignIsSite" value="true">
                    <div class="autocomplete-dd" id="panelUserDD"></div>
                </div>
            </div>
        </div>
        <div class="section"><h3>Premium</h3>
            <div class="field"><label>Expiring Premium</label><input type="number" id="pExpCost" step="0.01" placeholder="0.00"></div>
            <div class="field"><label>Renewal Premium</label><input type="number" id="pRenCost" step="0.01" placeholder="0.00"></div>
        </div>
        <div class="section"><h3>Notes</h3>
            <div class="field"><label>Notes</label><textarea id="pNotes" placeholder="Enter notes..."></textarea></div>
            <div class="field"><label>Internal Notes</label><textarea id="pIntNotes" placeholder="Internal notes..."></textarea></div>
        </div>`;
    document.getElementById('panel').classList.add('open');
    document.getElementById('panelBg').classList.add('open');
}

function openPanel(id){
    selected=policies.find(p=>p.id===id);if(!selected)return;
    document.getElementById('panelTitle').textContent=selected.Title;
    document.getElementById('panelBody').innerHTML=`
        <div class="section"><h3>Policy Information</h3>
            <div class="field"><label>Title</label><input id="pTitle" value="${selected.Title.replace(/"/g,'&quot;')}"></div>
            <div class="field"><label>Policy Number</label><input id="pNum" value="${selected.PolicyNumber}"></div>
            <div class="field"><label>Carrier / Company</label><input id="pCarrier" value="${(selected.Carrier||'').replace(/"/g,'&quot;')}"></div>
            <div class="field"><label>Policy Type</label><input id="pPolicyType" value="${selected.PolicyType||''}"></div>
            <div class="field"><label>Business with Agency</label><select id="pBizType"><option value="">Select...</option><option value="CL" ${selected.BizType==='CL'?'selected':''}>CL - Commercial</option><option value="PL" ${selected.BizType==='PL'?'selected':''}>PL - Personal</option></select></div>
            <div class="field"><label>Transaction Type</label><select id="pTransType"><option value="Renewal" ${selected.TransType==='Renewal'?'selected':''}>Renewal</option><option value="New Business" ${selected.TransType==='New Business'?'selected':''}>New Business</option></select></div>
        </div>
        <div class="section"><h3>Dates</h3>
            <div class="field"><label>Effective Date</label><input type="date" id="pEff" value="${selected.EffDate?selected.EffDate.split('T')[0]:''}"></div>
            <div class="field"><label>Expiration Date</label><input type="date" id="pExp" value="${selected.ExpDate?selected.ExpDate.split('T')[0]:''}"></div>
        </div>
        <div class="section"><h3>Policy Status</h3>
            <div class="field"><label>Renewal Status</label><select id="pStatus">${STATUSES.map(s=>`<option value="${s}" ${selected.Status===s?'selected':''}>${s}</option>`).join('')}</select></div>
            <div class="field"><label>Billing Status</label><select id="pBillStatus">${BILL_STATUSES.map(s=>`<option value="${s}" ${selected.BillStatus===s?'selected':''}>${s}</option>`).join('')}</select></div>
            <div class="field"><label>Assigned To</label>
                <div class="autocomplete">
                    <input type="text" id="pAssignName" value="${selected.AssignedName||''}" placeholder="Search users..." oninput="searchPanelUsers(this.value)" onfocus="searchPanelUsers(this.value)">
                    <input type="hidden" id="pAssignId" value="${selected.AssignedId||''}">
                    <input type="hidden" id="pAssignIsSite" value="true">
                    <div class="autocomplete-dd" id="panelUserDD"></div>
                </div>
            </div>
        </div>
        <div class="section"><h3>Premium</h3>
            <div class="field"><label>Expiring Premium</label><input type="number" id="pExpCost" step="0.01" value="${selected.ExpCost||''}"></div>
            <div class="field"><label>Renewal Premium</label><input type="number" id="pRenCost" step="0.01" value="${selected.RenCost||''}"></div>
        </div>
        <div class="section"><h3>Notes</h3>
            <div class="field"><label>Notes</label><textarea id="pNotes">${selected.Notes||''}</textarea></div>
            <div class="field"><label>Internal Notes</label><textarea id="pIntNotes">${selected.IntNotes||''}</textarea></div>
        </div>
        <div class="section"><h3>Other</h3>
            <div class="field"><label>Archived</label><select id="pArch"><option value="false" ${!selected.Archived?'selected':''}>No</option><option value="true" ${selected.Archived?'selected':''}>Yes</option></select></div>
        </div>`;
    document.getElementById('panel').classList.add('open');
    document.getElementById('panelBg').classList.add('open');
}

let panelSearchTimeout=null;
async function searchPanelUsers(q){const dd=document.getElementById('panelUserDD');q=q.trim().toLowerCase();if(q.length<2){dd.innerHTML=`<div class="autocomplete-opt" onclick="selectPanelUser('','',true)"><div class="avatar" style="background:#9ca3af">?</div>Unassigned</div>`+siteUsers.slice(0,10).map(u=>`<div class="autocomplete-opt" onclick="selectPanelUser('${u.id}','${u.name.replace(/'/g,"\\'")}',true)"><div class="avatar" style="background:${acolor(u.id,u.name)}">${init(u.name)}</div>${u.name}</div>`).join('');dd.classList.add('open');return}const siteMatches=siteUsers.filter(u=>u.name.toLowerCase().includes(q));dd.innerHTML=`<div class="autocomplete-opt" onclick="selectPanelUser('','',true)"><div class="avatar" style="background:#9ca3af">?</div>Unassigned</div>`+siteMatches.slice(0,10).map(u=>`<div class="autocomplete-opt" onclick="selectPanelUser('${u.id}','${u.name.replace(/'/g,"\\'")}',true)"><div class="avatar" style="background:${acolor(u.id,u.name)}">${init(u.name)}</div>${u.name}</div>`).join('');dd.classList.add('open');clearTimeout(panelSearchTimeout);panelSearchTimeout=setTimeout(async()=>{try{const r=await graph(`/users?$filter=startswith(displayName,'${encodeURIComponent(q)}')&$select=id,displayName,mail&$top=10`);const azUsers=r.value.map(u=>({id:u.id,name:u.displayName,email:u.mail}));const combined=[...siteMatches.map(u=>({...u,isSite:true}))];azUsers.forEach(au=>{if(!combined.find(su=>su.name.toLowerCase()===au.name.toLowerCase()))combined.push({...au,isSite:false})});dd.innerHTML=`<div class="autocomplete-opt" onclick="selectPanelUser('','',true)"><div class="avatar" style="background:#9ca3af">?</div>Unassigned</div>`+combined.slice(0,15).map(u=>`<div class="autocomplete-opt" onclick="selectPanelUser('${u.id}','${u.name.replace(/'/g,"\\'")}',${u.isSite!==false})"><div class="avatar" style="background:${acolor(u.id,u.name)}">${init(u.name)}</div><div><div>${u.name}</div>${u.email?`<div style="font-size:11px;color:#9ca3af">${u.email}</div>`:''}${u.isSite===false?`<div style="font-size:10px;color:#f59e0b">‚ö† Not in SharePoint</div>`:''}</div></div>`).join('')}catch(e){console.error(e)}},300)}

function selectPanelUser(id,name,isSite){document.getElementById('pAssignId').value=id;document.getElementById('pAssignName').value=name;document.getElementById('pAssignIsSite').value=isSite?'true':'false';document.getElementById('panelUserDD').classList.remove('open')}
function closePanel(){document.getElementById('panel').classList.remove('open');document.getElementById('panelBg').classList.remove('open');selected=null}

async function save(){
    const assignId=document.getElementById('pAssignId').value;
    const isSiteUser=document.getElementById('pAssignIsSite').value==='true';
    if(assignId&&!isSiteUser){toast('Add to SharePoint first','err');return}
    try{
        const fields={
            Title:document.getElementById('pTitle').value,
            PolicyNumber:document.getElementById('pNum').value,
            Carrier:document.getElementById('pCarrier').value,
            PolicyType:document.getElementById('pPolicyType')?.value||'',
            BusinessWithAgency:document.getElementById('pBizType')?.value||'',
            TransactionType:document.getElementById('pTransType').value,
            EffectiveDate:document.getElementById('pEff').value||null,
            ExpirationDate:document.getElementById('pExp').value||null,
            RenewalStatus:document.getElementById('pStatus').value,
            BillingStatus:document.getElementById('pBillStatus')?.value||'Not Started',
            ExpiringTotalCost:parseFloat(document.getElementById('pExpCost').value)||null,
            RenewalTotalCost:parseFloat(document.getElementById('pRenCost').value)||null,
            InternalNotes:document.getElementById('pIntNotes').value
        };
        fields[F_NOTES]=document.getElementById('pNotes').value;
        fields[F_ASSIGNED]=assignId?parseInt(assignId):null;
        const archEl=document.getElementById('pArch');
        if(archEl)fields.Archived=archEl.value==='true';
        
        if(selected){
            await graph(`/sites/${CONFIG.siteHost},${CONFIG.siteId}/lists/${CONFIG.listId}/items/${selected.id}/fields`,{method:'PATCH',body:JSON.stringify(fields)});
            Object.assign(selected,{Title:fields.Title,PolicyNumber:fields.PolicyNumber,Carrier:fields.Carrier,PolicyType:fields.PolicyType,BizType:fields.BusinessWithAgency,TransType:fields.TransactionType,EffDate:fields.EffectiveDate,ExpDate:fields.ExpirationDate,Status:fields.RenewalStatus,BillStatus:fields.BillingStatus,ExpCost:fields.ExpiringTotalCost,RenCost:fields.RenewalTotalCost,DollarChg:null,PctChg:null,Notes:fields[F_NOTES],IntNotes:fields.InternalNotes,Archived:fields.Archived,AssignedId:assignId||null,AssignedName:document.getElementById('pAssignName').value||null});
        }else{
            const r=await graph(`/sites/${CONFIG.siteHost},${CONFIG.siteId}/lists/${CONFIG.listId}/items`,{method:'POST',body:JSON.stringify({fields})});
            policies.push({id:r.id,Title:fields.Title,PolicyNumber:fields.PolicyNumber,PolicyType:fields.PolicyType,Carrier:fields.Carrier,BizType:fields.BusinessWithAgency,EffDate:fields.EffectiveDate,ExpDate:fields.ExpirationDate,ExpCost:fields.ExpiringTotalCost,RenCost:fields.RenewalTotalCost,DollarChg:null,PctChg:null,Status:fields.RenewalStatus,BillStatus:fields.BillingStatus,Notes:fields[F_NOTES],IntNotes:fields.InternalNotes,TransType:fields.TransactionType,Archived:false,AssignedId:assignId||null,AssignedName:document.getElementById('pAssignName').value||null});
        }
        toast(selected?'Saved!':'Policy created!','ok');
        closePanel();buildAssigneeFilter();buildPolicyStatusFilter();filter();updateStats();
        // Silent background refresh to pick up server-calculated fields ($ Change, % Change)
        setTimeout(()=>refreshData(true),500);
    }catch(e){console.error('Save:',e);toast('Save failed','err')}
}

function toast(msg,type){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(()=>t.classList.remove('show'),3000)}
</script>
</body>
</html>